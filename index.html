<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Scheduler (Stable)</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 10px; }
        
        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        input, textarea, button { 
            box-sizing: border-box; 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-family: inherit;
        }
        
        textarea { font-family: monospace; }
        
        .button-row { display: flex; gap: 10px; margin-top: 20px; }
        
        button { 
            width: auto; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            border: none;
        }
        
        #btnGenerate { background-color: #003366; color: white; } /* Navy */
        #btnGenerate:hover { background-color: #002244; }
        
        #btnShare { background-color: #4CAF50; color: white; } /* Green */
        #btnShare:hover { background-color: #45a049; }

        /* Schedule Output Styles */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; border: 2px solid #003366; }
        th { background-color: #003366; color: white; padding: 10px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <h1>ðŸŽ¾ Wednesday Tennis Scheduler</h1>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <label for="playerList">Player List (Format: Name, Ability)</label>
    <div class="help-text">Use commas between all values. Example: Alex, 4, Ben, 3.5</div>
    <textarea id="playerList" rows="6">Alex,4, Ben,3, Chloe,5, David,2, Emily,3, Finn,4, Grace,2, Hugo,5, Isaac,3, Jane,4, Karl,2, Leah,3, Mark,5, Nina,4, Owen,2, Pam,3, Quinn,4</textarea>

    <label for="courts1">6:30 PM Courts (List numbers/names)</label>
    <textarea id="courts1" rows="1">1, 2, 3, 4</textarea>

    <label for="courts2">7:30 PM Courts (List numbers/names)</label>
    <textarea id="courts2" rows="1">5, 6, 7, 8, 9</textarea>

    <div class="button-row">
        <button id="btnGenerate" onclick="generateSchedule()">1. Generate & Save</button>
        <button id="btnShare" onclick="openShareView()">2. View Shareable Page</button>
    </div>

    <div id="errorContainer" class="error-box"></div>

    <div id="output" class="schedule-output" style="display:none;"></div>

    <script>
        // --- 1. SAFE CONFIGURATION ---
        const STORAGE_KEY = 'tennis_roster_v2';

        // --- 2. INITIALIZATION (Runs when page loads) ---
        window.onload = function() {
            console.log("App initializing...");
            
            // A. Set Date to Next Wednesday
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; // 3 = Wednesday
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; // Next Wed
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch(e) { console.error("Date error", e); }

            // B. Load Roster from Storage (With Error Protection)
            try {
                const savedRoster = localStorage.getItem(STORAGE_KEY);
                if (savedRoster && savedRoster.length > 10) {
                    document.getElementById('playerList').value = savedRoster;
                }
            } catch(e) {
                console.warn("Could not load local storage. Using defaults.");
            }
        };

        // --- 3. PARSING HELPERS (The "Safe" Logic) ---
        function parsePlayers(text) {
            const rawItems = text.split(',');
            const players = [];
            
            // Step through 2 items at a time
            for (let i = 0; i < rawItems.length; i += 2) {
                // Check if both Name and Ability exist
                if (rawItems[i] !== undefined && rawItems[i+1] !== undefined) {
                    const name = rawItems[i].trim();
                    const abilityStr = rawItems[i+1].trim();
                    
                    // Only add if name is not empty and ability is a number
                    if (name.length > 0 && abilityStr.length > 0 && !isNaN(abilityStr)) {
                        players.push({
                            name: name,
                            ability: parseFloat(abilityStr)
                        });
                    }
                }
            }
            return players;
        }

        function parseCourts(text) {
            return text.split(',')
                       .map(c => c.trim())
                       .filter(c => c.length > 0); // Remove empty entries
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        // --- 4. CORE SCHEDULING ---
        function scheduleHour(pool, courts) {
            const numCourts = courts.length;
            const maxPlay = numCourts * 4;
            
            let playing = [];
            let sitting = [];

            // Sort pool by ability high -> low
            pool.sort((a,b) => b.ability - a.ability);

            if (pool.length > maxPlay) {
                playing = pool.slice(0, maxPlay);
                sitting = pool.slice(maxPlay);
            } else {
                playing = pool;
            }

            let schedule = [];
            let tempPool = [...playing];

            for(let i=0; i<numCourts; i++) {
                if(tempPool.length < 4) {
                    sitting.push(...tempPool);
                    break;
                }
                // Take Strongest, 2nd Strongest, Weakest, 2nd Weakest
                let p1 = tempPool.shift();
                let p2 = tempPool.shift();
                let p3 = tempPool.pop();
                let p4 = tempPool.pop();
                
                // Create random teams from these 4
                let courtGroup = shuffle([p1, p2, p3, p4]);
                schedule.push(courtGroup);
            }
            
            return { matches: schedule, sitOut: sitting };
        }

        // --- 5. MAIN GENERATE FUNCTION ---
        function generateSchedule() {
            const errBox = document.getElementById('errorContainer');
            const outBox = document.getElementById('output');
            
            // Reset display
            errBox.style.display = 'none';
            errBox.innerText = "";
            outBox.style.display = 'none';

            try {
                // 1. Get Inputs
                const pText = document.getElementById('playerList').value;
                const cText1 = document.getElementById('courts1').value;
                const cText2 = document.getElementById('courts2').value;
                const dateStr = document.getElementById('sessionDate').value;

                // 2. Save Roster
                localStorage.setItem(STORAGE_KEY, pText);

                // 3. Parse
                const players = parsePlayers(pText);
                const courts1 = parseCourts(cText1);
                const courts2 = parseCourts(cText2);

                // 4. Validate
                if (players.length < 4) throw "Not enough valid players (Need at least 4). Check comma formatting.";
                if (courts1.length === 0) throw "No courts listed for 6:30 PM.";
                if (courts2.length === 0) throw "No courts listed for 7:30 PM.";

                // 5. Run Logic
                let shuffledAll = shuffle([...players]);
                
                // Hour 1
                const res1 = scheduleHour(shuffledAll, courts1);
                
                // Hour 2 setup
                // Get names of who played in Hour 1
                const playedNamesH1 = res1.matches.flat().map(p => p.name);
                const playedObjH1 = players.filter(p => playedNamesH1.includes(p.name));
                
                // Priority pool: Sitters from H1 + Shuffled Players from H1
                const poolH2 = [...res1.sitOut, ...shuffle(playedObjH1)];
                
                // Hour 2
                const res2 = scheduleHour(poolH2, courts2);

                // 6. Render HTML
                const renderTable = (title, data, courts) => {
                    let html = `<h3>${title}</h3>`;
                    html += `<table><tr><th>Court</th><th>Player 1</th><th>Player 2</th><th>Player 3</th><th>Player 4</th></tr>`;
                    
                    data.matches.forEach((m, idx) => {
                        let cName = courts[idx] || (idx+1);
                        html += `<tr>
                            <td style="font-weight:bold;">${cName}</td>
                            <td>${m[0].name}</td>
                            <td>${m[1].name}</td>
                            <td>${m[2].name}</td>
                            <td>${m[3].name}</td>
                        </tr>`;
                    });

                    if(data.sitOut.length > 0) {
                        const names = data.sitOut.map(p => p.name).join(', ');
                        html += `<tr><td class="sit-out" colspan="5">Sit Out: ${names}</td></tr>`;
                    }
                    html += `</table>`;
                    return html;
                };

                let finalHtml = `<h2>Schedule: ${dateStr}</h2>`;
                finalHtml += renderTable("6:30 PM", res1, courts1);
                finalHtml += "<br><hr><br>";
                finalHtml += renderTable("7:30 PM", res2, courts2);

                outBox.innerHTML = finalHtml;
                outBox.style.display = 'block';

            } catch (err) {
                errBox.innerText = "Error: " + err;
                errBox.style.display = 'block';
            }
        }

        // --- 6. SHARE VIEW ---
        function openShareView() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            
            if (outBox.style.display === 'none') {
                alert("Please generate a schedule first.");
                return;
            }

            const win = window.open("", "_blank");
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tennis Schedule ${dateStr}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; text-align: center; }
                        h1 { color: #003366; }
                        h2 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px;}
                        h3 { margin-bottom: 5px; margin-top: 20px; color: #003366; }
                        table { width: 100%; max-width: 800px; margin: 0 auto; border-collapse: collapse; border: 2px solid #003366; }
                        th { background-color: #003366; color: white; padding: 10px; border: 1px solid #003366; }
                        td { border: 1px solid #ccc; padding: 10px; }
                        .sit-out { background-color: #eef; font-weight: bold; color: #003366; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>ðŸŽ¾ Tennis Schedule - ${dateStr}</h1>
                    ${outBox.innerHTML}
                    <br><br>
                    <button style="padding:10px 20px; font-size:16px;" onclick="window.print()">Print / PDF</button>
                </body>
                </html>
            `;
            win.document.write(htmlContent);
            win.document.close();
        }
    </script>
</body>
</html>
