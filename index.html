<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Tennis Scheduler (Ability-Weighted)</title>
    <style>
        /* CSS for the input/management view */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        h1 { color: #333; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        
        input[type="date"], button { 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            font-size: 16px;
        }
        
        textarea { 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            width: 100%; 
            box-sizing: border-box; /* Ensures padding doesn't break width */
            font-family: monospace;
        }
        
        button { 
            background-color: #4CAF50; 
            color: white; 
            cursor: pointer; 
            border: none; 
            margin-right: 10px; 
            padding: 12px 20px;
        }
        
        button:hover { background-color: #45a049; }
        
        .schedule-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .schedule-table th { background-color: #f2f2f2; }
        .sit-out { background-color: #ffe0e0; font-weight: bold; color: #d9534f; }
        .court-title { background-color: #e6f7ff; }
        .ability-note { font-size: 0.9em; color: #666; margin-bottom: 5px; font-style: italic; }
        .button-group { margin-top: 20px; padding: 10px 0; border-top: 1px solid #eee; }
        .error-msg { color: red; background-color: #ffeeee; padding: 10px; border: 1px solid red; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ðŸŽ¾ Weekly Tennis Scheduler</h1>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <label for="playerList">Player List (Name, Ability):</label>
    <div class="ability-note">Example: Alex, 4, Ben, 3.5 (Ensure commas separate names and scores)</div>
    <textarea id="playerList" rows="6">Alex,4, Ben,3, Chloe,5, David,2, Emily,3, Finn,4, Grace,2, Hugo,5, Isaac,3, Jane,4, Karl,2, Leah,3, Mark,5, Nina,4, Owen,2, Pam,3, Quinn,4</textarea>

    <label for="courtNamesHour1">6:30 PM Courts (Comma separated):</label>
    <div class="ability-note">Example: 12, 13, 14, 15</div>
    <textarea id="courtNamesHour1" rows="1">1, 2, 3, 4</textarea>

    <label for="courtNamesHour2">7:30 PM Courts (Comma separated):</label>
    <div class="ability-note">Example: 5, 6, 7, 8, 9</div>
    <textarea id="courtNamesHour2" rows="1">5, 6, 7, 8, 9</textarea>

    <div class="button-group">
        <button id="btnGenerate" onclick="generateSchedule()">Generate & Save Roster</button>
        <button id="btnShare" onclick="showShareableSchedule()" style="background-color: #007bff;">View Shareable Page</button>
    </div>

    <div id="scheduleOutput"></div>

    <script>
        // --- CONSTANTS ---
        const STORAGE_KEY = 'tennisSchedulerPlayerList';

        // --- UTILITY FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- CORE SCHEDULING LOGIC ---
        function scheduleByAbility(playerPool, numCourts) {
            let schedule = [];
            let sittingOut = [];
            let playersToPlay = [];

            const maxPlayers = numCourts * 4;
            
            // Determine who plays
            if (playerPool.length > maxPlayers) {
                playersToPlay = playerPool.slice(0, maxPlayers);
                sittingOut = playerPool.slice(maxPlayers);
            } else {
                playersToPlay = playerPool;
            }

            // Sort by ability (High -> Low)
            playersToPlay.sort((a, b) => b.ability - a.ability);
            let availablePlayers = [...playersToPlay];

            // Pair up
            for (let c = 0; c < numCourts; c++) {
                if (availablePlayers.length < 4) {
                     sittingOut.push(...availablePlayers);
                     break;
                }
                
                // Strategy: Strongest + Weakest vs 2nd Strongest + 2nd Weakest
                let p1 = availablePlayers.shift(); 
                let p2 = availablePlayers.shift(); 
                let p3 = availablePlayers.pop();   
                let p4 = availablePlayers.pop();   
                
                // Safety check: if pop() returns undefined (shouldn't happen with correct length check)
                if (!p1 || !p2 || !p3 || !p4) break;

                // Randomize positions within teams
                let teamA = shuffleArray([p1, p3]);
                let teamB = shuffleArray([p2, p4]); 
                
                let courtMatch = [...teamA, ...teamB];
                schedule.push(courtMatch);
            }

            return { schedule: schedule, sittingOut: sittingOut };
        }

        // --- LOCAL STORAGE ---
        function loadPlayersFromStorage() {
            try {
                const savedList = localStorage.getItem(STORAGE_KEY);
                if (savedList) {
                    document.getElementById('playerList').value = savedList;
                }
            } catch (e) {
                console.warn("Local Storage not available or restricted.");
            }
        }

        function savePlayersToStorage(playerListText) {
            try {
                localStorage.setItem(STORAGE_KEY, playerListText);
            } catch (e) {
                console.warn("Could not save to Local Storage.");
            }
        }

        // --- MAIN FUNCTION ---
        function generateSchedule() {
            const outputDiv = document.getElementById('scheduleOutput');
            outputDiv.innerHTML = "Processing..."; // Visual feedback

            try {
                const playersInputText = document.getElementById('playerList').value;
                const sessionDate = document.getElementById('sessionDate').value;
                
                // Save current list
                savePlayersToStorage(playersInputText);

                // Parse Courts
                const courtNames1 = document.getElementById('courtNamesHour1').value.split(',').map(n => n.trim()).filter(n => n !== '');
                const courtNames2 = document.getElementById('courtNamesHour2').value.split(',').map(n => n.trim()).filter(n => n !== '');

                // Parse Players with Error Handling
                let players = [];
                const rawSplit = playersInputText.split(',');
                
                for(let i=0; i < rawSplit.length; i += 2) {
                    if(rawSplit[i+1] !== undefined) {
                        const name = rawSplit[i].trim();
                        const abilityStr = rawSplit[i+1].trim();
                        const ability = parseFloat(abilityStr);
                        
                        if (name.length > 0 && !isNaN(ability)) {
                            players.push({ name: name, ability: ability });
                        }
                    }
                }

                // Validations
                if (players.length < 4) {
                    throw new Error("Not enough valid players found. Need at least 4. Check formatting (Name, Ability).");
                }
                if (courtNames1.length === 0 || courtNames2.length === 0) {
                    throw new Error("Please enter court numbers for both hours.");
                }

                // --- GENERATE HOUR 1 ---
                let shuffledPlayers = shuffleArray([...players]);
                let h1Result = scheduleByAbility(shuffledPlayers, courtNames1.length);
                
                // --- GENERATE HOUR 2 ---
                let playingHour1Names = h1Result.schedule.flat().map(p => p.name);
                let playingHour1 = players.filter(p => playingHour1Names.includes(p.name));
                let sittingOut1 = h1Result.sittingOut;

                // Prioritize those who sat out, then mix in players from hour 1
                let hour2Pool = [...sittingOut1, ...shuffleArray(playingHour1)];
                let h2Result = scheduleByAbility(hour2Pool, courtNames2.length);

                // --- DISPLAY HTML GENERATION ---
                const createTable = (title, schedule, sitOut, courtNames) => {
                    let html = `<h3>${title}</h3>`;
                    if(schedule.length === 0) return html + "<p>Not enough players to form a match.</p>";

                    html += '<table class="schedule-table">';
                    html += '<tr><th>Court</th><th>Team A</th><th>Team B</th></tr>'; // Simplified header
                    
                    schedule.forEach((match, index) => {
                        const cName = courtNames[index] || `Court ${index+1}`;
                        // match is [p1, p2, p3, p4]. Team A is 0&1. Team B is 2&3.
                        html += `<tr class="court-title">
                            <td>${cName}</td>
                            <td>${match[0].name} & ${match[1].name}</td>
                            <td>${match[2].name} & ${match[3].name}</td>
                        </tr>`;
                    });

                    if (sitOut.length > 0) {
                        const sitOutNames = sitOut.map(p => p.name).join(', ');
                        html += `<tr><td class="sit-out" colspan="3">Sit Out: ${sitOutNames}</td></tr>`;
                    }
                    html += '</table>';
                    return html;
                };

                let outputHTML = `<h2>Generated Schedule for ${sessionDate}</h2>`;
                outputHTML += createTable(`Hour 1 (6:30 PM)`, h1Result.schedule, sittingOut1, courtNames1);
                outputHTML += '<hr>';
                outputHTML += createTable(`Hour 2 (7:30 PM)`, h2Result.schedule, h2Result.sittingOut, courtNames2);

                outputDiv.innerHTML = outputHTML;

            } catch (err) {
                outputDiv.innerHTML = `<div class="error-msg"><strong>Error:</strong> ${err.message}</div>`;
                console.error(err);
            }
        }

        function showShareableSchedule() {
            const outputDiv = document.getElementById('scheduleOutput');
            const sessionDate = document.getElementById('sessionDate').value;
            
            if (!outputDiv.innerHTML || outputDiv.innerText === "Processing...") {
                alert("Please click 'Generate & Save Roster' first.");
                return;
            }
            
            const content = outputDiv.innerHTML;
            const newWin = window.open('', '_blank');
            newWin.document.write(`
                <html>
                <head>
                    <title>Tennis Schedule - ${sessionDate}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
                        h1, h2, h3 { color: #003366; border-bottom: 2px solid #ddd; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #ddd; }
                        th { background-color: #003366; color: white; padding: 10px; }
                        td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                        .sit-out { background-color: #f0f8ff; color: #003366; font-weight: bold; }
                        .court-title { font-size: 1.1em; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>ðŸŽ¾ Wednesday Night Tennis - ${sessionDate}</h1>
                    ${content}
                    <br><button onclick="window.print()">Print / Save PDF</button>
                </body>
                </html>
            `);
            newWin.document.close();
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // 1. Load Saved Players (Fail-safe)
            loadPlayersFromStorage();

            // 2. Set Date to Next Wednesday
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; // Wednesday
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; // If today is Wed, get next Wed
                
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch (e) {
                console.log("Date auto-set failed, user can set manually.");
            }
            
            // Note: We do NOT auto-generate schedule anymore. 
            // This prevents crashes on load.
        };
    </script>
</body>
</html>
