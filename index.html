<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen's Club Tennis Scheduler</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #003366; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; text-align: center; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .login-box h2 { color: #003366; margin-top: 0; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-box button:hover { background: #002244; }
        .login-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }

        /* Main App Layout */
        #app-container { display: none; }
        
        /* Header */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { color: #003366; margin: 0; font-size: 1.8em; }
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .user-email { font-size: 0.9em; color: #666; font-weight: bold; }
        .logout-btn { padding: 5px 10px; background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

        /* Columns */
        .container-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-master { flex: 1; min-width: 300px; }
        .col-weekly { flex: 2; min-width: 400px; }

        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; font-weight: 500; }
        .master-header { background-color: #444; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; font-weight: 500; }

        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        input[type="date"], textarea, select { box-sizing: border-box; width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-family: inherit; }
        textarea { font-family: monospace; font-size: 14px; }

        /* Action Buttons */
        .button-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { flex: 1; padding: 12px; font-weight: bold; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #btnGenerate { background-color: #003366; } 
        #btnShare { background-color: #4CAF50; } 
        #btnWord { background-color: #2b5797; }
        #btnClear { background-color: #d9534f; color: white; padding: 5px 15px; font-size: 14px; border:none; border-radius: 4px; cursor: pointer; }

        /* Resolver */
        .resolver-box { background-color: #fff3cd; border: 2px solid #ffc107; padding: 20px; margin-top: 20px; border-radius: 8px; display: none; }
        .unknown-item { background: white; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .suggestion-btn { background-color: #17a2b8; color: white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer;}
        .add-btn { background-color: #28a745; color: white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer;}

        /* Output */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #003366; font-size: 0.9em; }
        th { background-color: #003366; color: white; padding: 8px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        /* Drag & Drop */
        .player-chip { display: inline-block; background-color: #e7f3fe; border: 1px solid #003366; color: #003366; padding: 4px 8px; border-radius: 15px; margin: 2px; cursor: grab; transition: all 0.2s; font-weight: 500; }
        .player-chip:hover { background-color: #003366; color: white; }
        .player-chip:active { cursor: grabbing; }
        .over { transform: scale(1.1); background-color: #ffd700; border-color: #000; }
        .drag-hint { background-color: #e7f3fe; border-left: 6px solid #2196F3; margin-bottom: 15px; padding: 10px; font-size: 0.9em; }
        
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
        #dbStatus { font-size: 0.85em; color: green; font-weight: bold; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üéæ Tennis Planner</h2>
            <p style="font-size:0.9em; color:#666;">Please log in to access the roster.</p>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Log In</button>
            <button onclick="signup()" style="background-color: #4CAF50; margin-top:5px;">Create Account</button>
            <div id="login-msg" class="login-error"></div>
        </div>
    </div>

    <div id="app-container">
        <div class="header-row">
            <h1>üéæ Wednesday Staggered Schedule</h1>
            <div class="user-controls">
                <span id="user-display" class="user-email"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <label for="sessionDate">Session Date:</label>
        <input type="date" id="sessionDate" onchange="saveDataToCloud()">

        <div class="container-flex">
            
            <div class="col-master">
                <div class="group-container" style="background-color: #f9f9f9;">
                    <div class="master-header">üìÇ Master Player Bank</div>
                    <div class="help-text">Database of all regulars.<br>Format: <strong>Name, Rating, M/W</strong></div>
                    <textarea id="masterList" rows="30" oninput="saveDataToCloud(); updateDBStatus();" placeholder="Alex, 4, M&#10;Ben, 3, M..."></textarea>
                    <div id="dbStatus"></div>
                </div>
            </div>

            <div class="col-weekly">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button id="btnClear" onclick="clearWeeklyInputs()">üóëÔ∏è Clear Groups</button>
                </div>

                <div class="group-container">
                    <div class="group-header">Group 1: Early (4:30 - 6:30)</div>
                    <label>Players:</label>
                    <div class="help-text">Paste names here (e.g. "Alex").</div>
                    <textarea id="playersG1" rows="6" oninput="saveDataToCloud()"></textarea>
                    <label>Courts:</label>
                    <textarea id="courtsG1" rows="1" oninput="saveDataToCloud()">1, 2</textarea>
                </div>

                <div class="group-container">
                    <div class="group-header">Group 2: Late (5:30 - 7:30)</div>
                    <label>Players:</label>
                    <textarea id="playersG2" rows="10" oninput="saveDataToCloud()"></textarea>
                    <label>Courts:</label>
                    <textarea id="courtsG2" rows="1" oninput="saveDataToCloud()">3, 4, 5, 6</textarea>
                </div>
            </div>
        </div>

        <div class="button-row">
            <button id="btnGenerate" class="action-btn" onclick="startGenerationProcess()">1. Generate Schedule</button>
            <button id="btnShare" class="action-btn" onclick="openShareView()">2. View / Print PDF</button>
            <button id="btnWord" class="action-btn" onclick="downloadWordDoc()">3. Download Word Doc</button>
        </div>
        
        <div id="errorContainer" class="error-box"></div>

        <div id="resolverContainer" class="resolver-box">
            <div style="font-weight:bold; color:#856404; margin-bottom:10px;">‚ö†Ô∏è Unknown Players Detected</div>
            <p style="margin:0 0 10px 0;">Names not found in Bank. Fix typo or Add:</p>
            <div id="resolverList"></div>
        </div>
        
        <div id="output" class="schedule-output"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZPyd_grTtcXGGBA3s7CQVGt-SXDm_QkA",
            authDomain: "project-8381867246864635545.firebaseapp.com",
            databaseURL: "https://project-8381867246864635545-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-8381867246864635545",
            storageBucket: "project-8381867246864635545.firebasestorage.app",
            messagingSenderId: "531514593264",
            appId: "1:531514593264:web:5ac9c140c374f63eb99735"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let isCloudLoading = false;

        window.login = login;
        window.signup = signup;
        window.logout = logout;
        window.saveDataToCloud = saveDataToCloud;
        window.clearWeeklyInputs = clearWeeklyInputs;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('user-display').innerText = user.email;
                loadDataFromCloud();
            } else {
                currentUser = null;
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        async function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (error) { document.getElementById('login-msg').innerText = error.message; document.getElementById('login-msg').style.display='block'; }
        }

        async function signup() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await createUserWithEmailAndPassword(auth, e, p); }
            catch (error) { document.getElementById('login-msg').innerText = error.message; document.getElementById('login-msg').style.display='block'; }
        }

        async function logout() { await signOut(auth); }

        function loadDataFromCloud() {
            if (!currentUser) return;
            isCloudLoading = true;
            const userRef = ref(db, 'users/' + currentUser.uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.master) document.getElementById('masterList').value = data.master;
                    if (data.p1) document.getElementById('playersG1').value = data.p1;
                    if (data.c1) document.getElementById('courtsG1').value = data.c1;
                    if (data.p2) document.getElementById('playersG2').value = data.p2;
                    if (data.c2) document.getElementById('courtsG2').value = data.c2;
                    if (data.date) document.getElementById('sessionDate').value = data.date;
                    window.updateDBStatus();
                } else { setNextWednesday(); }
                isCloudLoading = false;
            });
        }

        function saveDataToCloud() {
            if (!currentUser || isCloudLoading) return;
            const data = {
                master: document.getElementById('masterList').value,
                p1: document.getElementById('playersG1').value,
                c1: document.getElementById('courtsG1').value,
                p2: document.getElementById('playersG2').value,
                c2: document.getElementById('courtsG2').value,
                date: document.getElementById('sessionDate').value
            };
            set(ref(db, 'users/' + currentUser.uid), data);
        }

        function clearWeeklyInputs() {
            if(confirm("Clear weekly inputs? Master Bank will remain.")) {
                document.getElementById('playersG1').value = "";
                document.getElementById('playersG2').value = "";
                document.getElementById('resolverContainer').style.display = 'none';
                document.getElementById('output').style.display = 'none';
                saveDataToCloud();
            }
        }

        function setNextWednesday() {
            const dateInput = document.getElementById('sessionDate');
            if(dateInput.value) return; 
            const today = new Date();
            let diff = (3 + 7 - today.getDay()) % 7;
            if (diff === 0) diff = 7; 
            const nextWed = new Date(today);
            nextWed.setDate(today.getDate() + diff);
            dateInput.value = nextWed.toISOString().split('T')[0];
        }
    </script>

    <script>
        function getMasterDatabase() {
            const masterText = document.getElementById('masterList').value;
            const db = {};
            const lines = masterText.split(/\r?\n/);
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const ability = parseFloat(parts[1].trim());
                    let gender = 'U';
                    if(parts.length >= 3) gender = parts[2].trim().toUpperCase();
                    if(name && !isNaN(ability)) {
                        db[name.toLowerCase()] = { name: name, ability: ability, gender: gender };
                    }
                }
            });
            return db;
        }

        function updateDBStatus() {
            const db = getMasterDatabase();
            const count = Object.keys(db).length;
            document.getElementById('dbStatus').innerText = `‚úÖ Cloud Synced: ${count} players`;
        }

        // --- SMARTER FUZZY MATCHING ---
        function getSimilarity(s1, s2) {
            let longer = s1; let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength == 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            let costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function findClosestMatch(inputName, dbKeys) {
            const lowerInput = inputName.toLowerCase();
            let bestMatch = null;
            let highestScore = 0;

            dbKeys.forEach(key => {
                const lowerKey = key.toLowerCase();
                let score = 0;

                // 1. Starts With
                if (lowerKey.startsWith(lowerInput)) score = 0.95;
                // 2. Contains
                else if (lowerKey.includes(lowerInput)) score = 0.85;
                // 3. Levenshtein
                else {
                    score = getSimilarity(lowerInput, lowerKey);
                }

                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = key;
                }
            });
            // Threshold
            return highestScore > 0.5 ? bestMatch : null;
        }

        // --- PRE-CHECK ---
        function startGenerationProcess() {
            document.getElementById('resolverContainer').style.display = 'none';
            document.getElementById('output').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';

            const p1 = document.getElementById('playersG1').value;
            const p2 = document.getElementById('playersG2').value;
            const db = getMasterDatabase();
            const unknowns = [];

            const scan = (text, fid) => {
                text.split(/[\r\n,]+/).forEach(token => {
                    token = token.trim();
                    if(!token || /\d/.test(token)) return; 
                    if (!db[token.toLowerCase()]) {
                        if(!unknowns.find(u => u.name === token)) unknowns.push({name:token, id:fid});
                    }
                });
            };
            scan(p1, 'playersG1'); scan(p2, 'playersG2');

            if (unknowns.length > 0) showResolver(unknowns, db);
            else generateAllSchedules();
        }

        function showResolver(unknowns, db) {
            const list = document.getElementById('resolverList');
            list.innerHTML = "";
            const keys = Object.keys(db);

            unknowns.forEach(u => {
                const closestKey = findClosestMatch(u.name, keys);
                let suggestionHtml = "";
                
                if (closestKey) {
                    const properName = db[closestKey].name;
                    suggestionHtml = `<button class="suggestion-btn" onclick="fixTypo('${u.name}', '${properName}', '${u.id}')">Fix: <strong>${properName}</strong></button> <span style="font-size:0.9em; margin:0 5px;">or</span> `;
                }

                const div = document.createElement('div');
                div.className = 'unknown-item';
                div.innerHTML = `
                    <span style="font-weight:bold; color:#d9534f; min-width:80px;">"${u.name}"</span>
                    ${suggestionHtml}
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="r_${u.name}" placeholder="Rate" step="0.5" style="width:60px; padding:5px;">
                        <select id="g_${u.name}" style="padding:5px;"><option value="M">M</option><option value="W">W</option></select>
                        <button class="add-btn" onclick="addToBank('${u.name}')">Add New</button>
                    </div>
                `;
                list.appendChild(div);
            });
            document.getElementById('resolverContainer').style.display = 'block';
        }

        window.fixTypo = function(bad, good, id) {
            const el = document.getElementById(id);
            el.value = el.value.replace(new RegExp(`\\b${bad}\\b`, 'g'), good);
            saveDataToCloud(); 
            startGenerationProcess();
        }

        window.addToBank = function(name) {
            const r = document.getElementById('r_'+name).value;
            const g = document.getElementById('g_'+name).value;
            if(!r) return alert("Enter rating");
            const master = document.getElementById('masterList');
            master.value += `\n${name}, ${r}, ${g}`;
            saveDataToCloud(); 
            startGenerationProcess();
        }

        // --- SCHEDULING (Logic Retained) ---
        function parse(txt, db) {
            const res = [];
            txt.split(/[\r\n,]+/).forEach(t => {
                t = t.trim();
                if(!t) return;
                if(db[t.toLowerCase()]) res.push(db[t.toLowerCase()]);
                else if (/\d/.test(t)) { /* Manual entry skip */ }
                else res.push({name: t+" (?)", ability:3, gender:'U'}); 
            });
            return res;
        }
        function parseC(t) { return t.replace(/[\r\n]+/g, ',').split(',').map(c=>c.trim()).filter(c=>c.length>0); }
        function shuffle(a) { return a.sort(()=>Math.random()-0.5); }
        function getPairKey(a,b) { return [a.name, b.name].sort().join('|'); }

        function schedule(players, courts, times) {
            if(!players.length) return null;
            const cap = courts.length * 4;
            
            const sel1 = determinePool([...players], cap);
            const res1 = createMatches(sel1.playing, courts, new Set());
            res1.sitOut = sel1.sitting;
            
            const hist = new Set();
            res1.matches.forEach(m => { hist.add(getPairKey(m[0], m[1])); hist.add(getPairKey(m[2], m[3])); });

            const mustPlay = [...res1.sitOut];
            const pNames = res1.matches.flat().map(p=>p.name);
            const candidates = players.filter(p=>pNames.includes(p.name));
            
            const sel2 = { playing: [...mustPlay], sitting: [] };
            const shufCand = shuffle(candidates);
            while(sel2.playing.length < cap && shufCand.length > 0) sel2.playing.push(shufCand.pop());
            sel2.sitting = shufCand;
            
            const res2 = createMatches(sel2.playing, courts, hist);
            res2.sitOut = sel2.sitting;

            return { t1: times[0], r1: res1, t2: times[1], r2: res2 };
        }

        function determinePool(pool, cap) {
            if(pool.length <= cap) return {playing: pool, sitting: []};
            const needed = pool.length - cap;
            const fives = shuffle(pool.filter(p=>p.ability>=5));
            const others = shuffle(pool.filter(p=>p.ability<5)).sort((a,b)=>b.ability-a.ability);
            
            const sit = [];
            while(sit.length < needed && fives.length) sit.push(fives.pop());
            while(sit.length < needed && others.length) sit.push(others.shift());
            return { playing: [...fives, ...others], sitting: sit };
        }

        function createMatches(pool, courts, hist) {
            pool.sort((a,b)=>b.ability-a.ability); 
            const matches = [];
            let temp = [...pool];
            
            for(let i=0; i<courts.length; i++) {
                if(temp.length < 4) break;
                let p1 = temp.shift(), p2 = temp.shift(), p3 = temp.shift(), p4 = temp.shift();
                
                const combos = [[[0,1],[2,3]], [[0,2],[1,3]], [[0,3],[1,2]]];
                let bestSc = -9999, bestC = null;
                const set = [p1,p2,p3,p4];

                combos.forEach(c => {
                    const t1a=set[c[0][0]], t1b=set[c[0][1]], t2a=set[c[1][0]], t2b=set[c[1][1]];
                    let sc = 0;
                    if(hist.has(getPairKey(t1a,t1b))) sc -= 10000;
                    if(hist.has(getPairKey(t2a,t2b))) sc -= 10000;
                    
                    const m1 = (t1a.gender!=t1b.gender && t1a.gender!='U' && t1b.gender!='U');
                    const m2 = (t2a.gender!=t2b.gender && t2a.gender!='U' && t2b.gender!='U');
                    if(m1 && m2) sc += 500; else if(m1||m2) sc+=50;
                    
                    sc -= Math.abs((t1a.ability+t1b.ability)-(t2a.ability+t2b.ability)) * 20;
                    if(sc > bestSc) { bestSc = sc; bestC = [t1a,t1b,t2a,t2b]; }
                });
                matches.push(bestC);
            }
            return { matches: matches, sitOut: [] };
        }

        function generateAllSchedules() {
            const p1 = document.getElementById('playersG1').value;
            const c1 = document.getElementById('courtsG1').value;
            const p2 = document.getElementById('playersG2').value;
            const c2 = document.getElementById('courtsG2').value;
            const db = getMasterDatabase();

            const players1 = parse(p1, db);
            const courts1 = parseC(c1);
            const r1 = schedule(players1, courts1, ["4:30 PM", "5:30 PM"]);

            const players2 = parse(p2, db);
            const courts2 = parseC(c2);
            const r2 = schedule(players2, courts2, ["5:30 PM", "6:30 PM"]);

            let h = "<div class='drag-hint'>üí° <strong>Tip:</strong> Drag names to swap players.</div>";
            if(r1) h += renderGroup("Group 1 (Early)", r1, courts1);
            if(r1 && r2) h += "<br><hr style='border-top:3px double #003366'><br>";
            if(r2) h += renderGroup("Group 2 (Late)", r2, courts2);

            const out = document.getElementById('output');
            out.innerHTML = h || "Add players.";
            out.style.display = 'block';
            enableDrag();
        }

        function renderGroup(title, d, cNames) {
            let h = `<h2>${title}</h2>`;
            const tbl = (time, r) => {
                let t = `<h3>${time}</h3><table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
                r.matches.forEach((m, i) => {
                    t += `<tr><td style="font-weight:bold;">${cNames[i]||(i+1)}</td>
                    <td>${chip(m[0])} & ${chip(m[1])}</td>
                    <td>${chip(m[2])} & ${chip(m[3])}</td></tr>`;
                });
                if(r.sitOut.length) t+= `<tr><td class="sit-out" colspan="3">Sit Out: ${r.sitOut.map(chip).join(' ')}</td></tr>`;
                return t + "</table>";
            };
            return h + tbl(d.t1, d.r1) + tbl(d.t2, d.r2);
        }

        function chip(p) { return `<span class="player-chip" draggable="true">${p.name}</span>`; }

        function enableDrag() {
            let dragSrc = null;
            document.querySelectorAll('.player-chip').forEach(item => {
                item.addEventListener('dragstart', function(e) { dragSrc=this; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/html', this.innerHTML); this.style.opacity='0.4'; });
                item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
                item.addEventListener('drop', function(e) { e.stopPropagation(); if(dragSrc!=this){ const t=this.innerHTML; this.innerHTML=dragSrc.innerHTML; dragSrc.innerHTML=t; } return false; });
                item.addEventListener('dragend', function() { this.style.opacity='1'; });
            });
        }

        function openShareView() {
            const out = document.getElementById('output');
            if(out.style.display=='none') return alert("Generate first");
            let c = out.innerHTML.replace(/<span class="player-chip"[^>]*>/g, "").replace(/<\/span>/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");
            const w = window.open("","_blank");
            w.document.write(`<html><head><title>Schedule</title><style>body{font-family:sans-serif;padding:20px;text-align:center;}table{width:100%;border-collapse:collapse;margin:0 auto;}th{background:#003366;color:white;padding:8px;}td{border:1px solid #ccc;padding:8px;}.sit-out{background:#eef;font-weight:bold;}</style></head><body><h1>Schedule</h1>${c}<br><button onclick="window.print()">Print</button></body></html>`);
            w.document.close();
        }

        function downloadWordDoc() {
            const out = document.getElementById('output');
            if(out.style.display=='none') return alert("Generate first");
            let c = out.innerHTML.replace(/<span class="player-chip"[^>]*>/g, "").replace(/<\/span>/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");
            const h = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Schedule</title><style>body{font-family:sans-serif;}table{width:100%;border-collapse:collapse;}td,th{border:1px solid #000;padding:5px;text-align:center;}th{background:#003366;color:white;}</style></head><body>" + c + "</body></html>";
            const b = new Blob([h], {type: 'application/msword'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = "schedule.doc"; document.body.appendChild(a); a.click();
        }
    </script>
</body>
</html>
