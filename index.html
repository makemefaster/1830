<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wednesday Staggered Tennis Schedule</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 10px; }
        h2 { color: #003366; margin-top: 30px; border-bottom: 1px solid #ccc; }
        
        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        /* Layout */
        .container-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-master { flex: 1; min-width: 300px; border-right: 2px dashed #ccc; padding-right: 20px; }
        .col-weekly { flex: 2; min-width: 400px; }

        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }
        .master-header { background-color: #444; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }

        input, textarea, button, select { 
            box-sizing: border-box; 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-family: inherit;
        }
        
        textarea { font-family: monospace; font-size: 14px; }
        
        /* Button Styles */
        .button-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        button { 
            width: auto; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            border: none;
            padding: 12px 24px;
            flex: 1;
        }
        
        #btnGenerate { background-color: #003366; color: white; } 
        #btnGenerate:hover { background-color: #002244; }
        #btnShare { background-color: #4CAF50; color: white; } 
        #btnShare:hover { background-color: #45a049; }
        #btnWord { background-color: #2b5797; color: white; }
        #btnWord:hover { background-color: #1e3f6f; }
        #btnClear { background-color: #d9534f; color: white; flex: 0 0 auto; }
        #btnClear:hover { background-color: #c9302c; }

        /* Output Styles */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #003366; font-size: 0.9em; }
        th { background-color: #003366; color: white; padding: 8px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        /* INDIVIDUAL DRAG AND DROP STYLES */
        .player-chip {
            display: inline-block;
            background-color: #e7f3fe;
            border: 1px solid #003366;
            color: #003366;
            padding: 4px 8px;
            border-radius: 15px;
            margin: 2px;
            cursor: grab;
            transition: all 0.2s;
            font-weight: 500;
        }
        .player-chip:hover { background-color: #003366; color: white; }
        .player-chip:active { cursor: grabbing; }
        .over { transform: scale(1.1); background-color: #ffd700; border-color: #000; }

        /* UNKNOWN PLAYER RESOLVER STYLES */
        .resolver-box {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        .resolver-title { font-weight: bold; font-size: 1.2em; color: #856404; margin-bottom: 10px; }
        .unknown-item {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .unknown-name { font-weight: bold; color: #d9534f; min-width: 100px; }
        .suggestion-btn { background-color: #17a2b8; color: white; padding: 5px 10px; font-size: 14px; flex: 0; }
        .add-btn { background-color: #28a745; color: white; padding: 5px 10px; font-size: 14px; flex: 0; }
        
        .drag-hint { background-color: #e7f3fe; border-left: 6px solid #2196F3; margin-bottom: 15px; padding: 10px; font-size: 0.9em; }
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
        #dbStatus { font-size: 0.85em; color: green; font-weight: bold; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

    <h1>üéæ Wednesday Staggered Schedule</h1>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <div class="container-flex">
        
        <div class="col-master">
            <div class="group-container" style="background-color: #f9f9f9;">
                <div class="master-header">üìÇ Master Player Bank</div>
                <div class="help-text">Database of all regulars.<br>Format: <strong>Name, Rating, M/W</strong> (One per line)</div>
                <textarea id="masterList" rows="30" oninput="updateDBStatus()" placeholder="Alex, 4, M&#10;Ben, 3, M&#10;...">Amir Lari,3,M
Annabel Royden,3,F
Bridgett Walters,5,F
Daniel Hazan,2,M
Gabriella Di Nora,4,F
Heather Mott,3,F
Howard Cramer,4,F
Katherine Maguire,2,F
Martyn Robertson,4,M
Massimiliano Casini,2,M
Michael McKinnon,5,M
Alexandra Stopps,3,F
Anna Allen-Jones,2,F
Antonio Tomassini,3,F
Benedetta,3,F
Christina Houston Edwards,2,F
Christopher O'Callaghan,3,F
David Drayson,2,M
David Henderson-Williams,2,M
Denys Firth,2,M
Donna Didizian,2,F
Elizabeth Agha,2,F
Eric Wilkinson,2,M
Fen Aird,3,F
Frederick Satow,2,M
Gwenyth Davis,3,F
James Hall,2,M
Jane Asscher,3,F
Jane Ylvisaker,4,F
Jennifer Hall,3,F
John Evangelides,3,M
John Yorke,2,M
Julie Baldwin,3,F
Jurate Hardy,1,F
Kate Rowe,3,F
Michael Stone,2,M
Miguel Caparros,3,M
Minnie Badenoch,4,F
Nigel Gurkin,2,M
Olga Selivanova,2,F
Penelope Davis,3,M
Philip Watson,3,M
Philip Wilkinson ,2,M
Philippe Goffin,3,M
Raj Persaud,3,M
Richard Hanreck,3,M
Richard Prosser,2,M
Roslyn Watson,3,F
Russell Duckworth,2,M
Sally Dargavel,2,F
Shahnaz Atighetchi,3,F
Shona Stopford Sackille,3,F
Simon H. Davies,3,M
Steffi Spitznagel,3,F</textarea>
                <div id="dbStatus"></div>
            </div>
        </div>

        <div class="col-weekly">
            <div style="text-align: right; margin-bottom: 10px;">
                <button id="btnClear" onclick="clearWeeklyInputs()" style="padding: 5px 15px; font-size: 14px;">üóëÔ∏è Clear Groups</button>
            </div>

            <div id="resolverContainer" class="resolver-box">
                <div class="resolver-title">‚ö†Ô∏è Unknown Players Detected</div>
                <p>The following names are not in your Master Bank. Please fix typos or add them as new players.</p>
                <div id="resolverList"></div>
            </div>

            <div class="group-container">
                <div class="group-header">Group 1: Early (4:30 - 6:30)</div>
                <label>Players Playing This Week:</label>
                <div class="help-text">Paste names only (e.g., "Alex") OR full details.</div>
                <textarea id="playersG1" rows="6"></textarea>
                <label>Courts:</label>
                <textarea id="courtsG1" rows="1">1, 2</textarea>
            </div>

            <div class="group-container">
                <div class="group-header">Group 2: Late (5:30 - 7:30)</div>
                <label>Players Playing This Week:</label>
                <div class="help-text">Paste names only (e.g., "Isaac") OR full details.</div>
                <textarea id="playersG2" rows="10"></textarea>
                <label>Courts:</label>
                <textarea id="courtsG2" rows="1">3, 4, 5, 6</textarea>
            </div>
        </div>
    </div>

    <div class="button-row">
        <button id="btnGenerate" onclick="startGenerationProcess()">1. Generate Schedule</button>
        <button id="btnShare" onclick="openShareView()">2. View / Print PDF</button>
        <button id="btnWord" onclick="downloadWordDoc()">3. Download Word Doc</button>
    </div>

    <div id="errorContainer" class="error-box"></div>
    
    <div id="output" class="schedule-output"></div>

    <script>
        const STORAGE_KEY = 'tennis_staggered_v10_resolver';

        // --- INITIALIZATION ---
        window.onload = function() {
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; 
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; 
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch(e) {}

            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if(data.master) document.getElementById('masterList').value = data.master;
                    document.getElementById('playersG1').value = data.p1 || "";
                    document.getElementById('courtsG1').value = data.c1 || "";
                    document.getElementById('playersG2').value = data.p2 || "";
                    document.getElementById('courtsG2').value = data.c2 || "";
                }
            } catch(e) {}
            
            updateDBStatus();
        };

        function clearWeeklyInputs() {
            if(confirm("Clear weekly inputs? Master Bank will be saved.")) {
                document.getElementById('playersG1').value = "";
                document.getElementById('playersG2').value = "";
                document.getElementById('resolverContainer').style.display = 'none';
            }
        }

        function getMasterDatabase() {
            const masterText = document.getElementById('masterList').value;
            const db = {};
            const lines = masterText.split(/\r?\n/);
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const ability = parseFloat(parts[1].trim());
                    let gender = 'U';
                    if(parts.length >= 3) gender = parts[2].trim().toUpperCase();
                    if(name && !isNaN(ability)) {
                        db[name.toLowerCase()] = { name: name, ability: ability, gender: gender };
                    }
                }
            });
            return db;
        }

        function updateDBStatus() {
            const db = getMasterDatabase();
            const count = Object.keys(db).length;
            document.getElementById('dbStatus').innerText = `‚úÖ Loaded ${count} players from Master Bank`;
        }

        // --- FUZZY MATCHING (Levenshtein Distance) ---
        function getSimilarity(s1, s2) {
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength == 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }

        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            let costs = new Array();
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function findClosestMatch(name, dbKeys) {
            let bestMatch = null;
            let highestScore = 0;
            dbKeys.forEach(key => {
                const score = getSimilarity(name.toLowerCase(), key);
                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = key;
                }
            });
            // Return match if > 60% similar, else null
            return highestScore > 0.6 ? bestMatch : null;
        }

        // --- PRE-GENERATION CHECK ---
        function startGenerationProcess() {
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('output').style.display = 'none';
            document.getElementById('resolverContainer').style.display = 'none';

            const p1Text = document.getElementById('playersG1').value;
            const p2Text = document.getElementById('playersG2').value;
            const db = getMasterDatabase();
            const unknowns = [];

            // Helper to scan text for unknown names
            const scanForUnknowns = (text, fieldId) => {
                const lines = text.split(/[\r\n,]+/);
                lines.forEach(line => {
                    let token = line.trim();
                    if(!token) return;
                    // Skip if looks like manual entry "Name, 4"
                    if (/\d/.test(token)) return; 
                    
                    if (!db[token.toLowerCase()]) {
                        // Check if we already found this unknown
                        if(!unknowns.find(u => u.name === token)) {
                            unknowns.push({ name: token, fieldId: fieldId });
                        }
                    }
                });
            };

            scanForUnknowns(p1Text, 'playersG1');
            scanForUnknowns(p2Text, 'playersG2');

            if (unknowns.length > 0) {
                showResolver(unknowns, db);
            } else {
                generateAllSchedules();
            }
        }

        function showResolver(unknowns, db) {
            const container = document.getElementById('resolverList');
            container.innerHTML = "";
            const dbKeys = Object.keys(db);

            unknowns.forEach(u => {
                const closest = findClosestMatch(u.name, dbKeys);
                let suggestionHtml = "";
                
                if (closest) {
                    const properName = db[closest].name;
                    suggestionHtml = `
                        <span>Did you mean: </span>
                        <button class="suggestion-btn" onclick="resolveTypo('${u.name}', '${properName}', '${u.fieldId}')">${properName}</button>
                        <span> OR </span>
                    `;
                }

                const div = document.createElement('div');
                div.className = 'unknown-item';
                div.innerHTML = `
                    <div class="unknown-name">"${u.name}"</div>
                    ${suggestionHtml}
                    <div style="flex:1; display:flex; gap:5px; align-items:center;">
                        <span>New:</span>
                        <input type="number" id="rating_${u.name}" placeholder="Rating" step="0.5" style="width:70px;">
                        <select id="gender_${u.name}" style="width:60px;">
                            <option value="M">M</option>
                            <option value="W">W</option>
                        </select>
                        <button class="add-btn" onclick="resolveNew('${u.name}')">Add to Bank</button>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('resolverContainer').style.display = 'block';
        }

        function resolveTypo(wrongName, rightName, fieldId) {
            const field = document.getElementById(fieldId);
            // Replace word boundary matching to ensure we don't replace parts of other words
            const regex = new RegExp(`\\b${wrongName}\\b`, 'g');
            field.value = field.value.replace(regex, rightName);
            // Re-run check
            startGenerationProcess();
        }

        function resolveNew(name) {
            const rating = document.getElementById(`rating_${name}`).value;
            const gender = document.getElementById(`gender_${name}`).value;
            
            if(!rating) { alert("Please enter a rating."); return; }

            // Add to Master List
            const masterBox = document.getElementById('masterList');
            const newLine = `\n${name}, ${rating}, ${gender}`;
            masterBox.value += newLine;
            
            // Save immediately
            updateDBStatus();
            
            // Re-run check
            startGenerationProcess();
        }

        // --- SCHEDULING (Existing Logic) ---
        function parsePlayers(text, db) {
            const rawLines = text.split(/[\r\n,]+/);
            const players = [];
            for (let i = 0; i < rawLines.length; i++) {
                let token = rawLines[i].trim();
                if(token.length === 0) continue;

                if (db[token.toLowerCase()]) {
                    players.push(db[token.toLowerCase()]);
                } 
                else if (i + 1 < rawLines.length && !isNaN(parseFloat(rawLines[i+1]))) {
                    const name = token;
                    const ability = parseFloat(rawLines[i+1]);
                    let gender = 'U';
                    if(i + 2 < rawLines.length) {
                        const potentialGender = rawLines[i+2].trim().toUpperCase();
                        if(potentialGender === 'M' || potentialGender === 'W') {
                            gender = potentialGender;
                            i += 2; 
                        } else { i += 1; }
                    } else { i += 1; }
                    players.push({ name, ability, gender });
                }
                else {
                    // Should be caught by resolver, but failsafe:
                    players.push({ name: token + " (?)", ability: 3, gender: 'U' });
                }
            }
            return players;
        }

        function parseCourts(text) {
            return text.replace(/[\r\n]+/g, ',').split(',').map
