<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wednesday Staggered Tennis Schedule</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 10px; }
        h2 { color: #003366; margin-top: 30px; border-bottom: 1px solid #ccc; }
        
        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }

        input, textarea, button { 
            box-sizing: border-box; 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-family: inherit;
        }
        
        textarea { font-family: monospace; }
        
        .button-row { display: flex; gap: 10px; margin-top: 20px; }
        
        button { 
            width: auto; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            border: none;
            padding: 12px 24px;
        }
        
        #btnGenerate { background-color: #003366; color: white; }
        #btnGenerate:hover { background-color: #002244; }
        
        #btnShare { background-color: #4CAF50; color: white; }
        #btnShare:hover { background-color: #45a049; }

        /* Output Styles */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #003366; font-size: 0.9em; }
        th { background-color: #003366; color: white; padding: 8px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <h1>ðŸŽ¾ Wednesday Staggered Schedule</h1>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <div class="group-container">
        <div class="group-header">Group 1: Early Starters (4:30 PM - 6:30 PM)</div>
        
        <label for="playersG1">Players (8 players normal):</label>
        <textarea id="playersG1" rows="4">Alex,4, Ben,3, Chloe,5, David,2, Emily,3, Finn,4, Grace,2, Hugo,5</textarea>
        
        <label for="courtsG1">Courts (4:30 & 5:30):</label>
        <div class="help-text">Normally 2 courts</div>
        <textarea id="courtsG1" rows="1">1, 2</textarea>
    </div>

    <div class="group-container">
        <div class="group-header">Group 2: Late Starters (5:30 PM - 7:30 PM)</div>
        
        <label for="playersG2">Players (16 players normal):</label>
        <textarea id="playersG2" rows="6">Isaac,3, Jane,4, Karl,2, Leah,3, Mark,5, Nina,4, Owen,2, Pam,3, Quinn,4, Rob,3, Steve,4, Tim,2, Ursula,3, Victor,5, Will,4, Xena,3</textarea>
        
        <label for="courtsG2">Courts (5:30 & 6:30):</label>
        <div class="help-text">Normally 4 courts</div>
        <textarea id="courtsG2" rows="1">3, 4, 5, 6</textarea>
    </div>

    <div class="button-row">
        <button id="btnGenerate" onclick="generateAllSchedules()">Generate Schedule</button>
        <button id="btnShare" onclick="openShareView()">View Shareable Page</button>
    </div>

    <div id="errorContainer" class="error-box"></div>
    <div id="output" class="schedule-output"></div>

    <script>
        const STORAGE_KEY = 'tennis_staggered_v1';

        // --- INITIALIZATION ---
        window.onload = function() {
            // Set Date to Next Wednesday
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; // Wednesday
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; 
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch(e) {}

            // Load Saved Data
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('playersG1').value = data.p1 || "";
                    document.getElementById('courtsG1').value = data.c1 || "";
                    document.getElementById('playersG2').value = data.p2 || "";
                    document.getElementById('courtsG2').value = data.c2 || "";
                }
            } catch(e) {}
        };

        // --- PARSING ---
        function parsePlayers(text) {
            const rawItems = text.split(',');
            const players = [];
            for (let i = 0; i < rawItems.length; i += 2) {
                if (rawItems[i] && rawItems[i+1]) {
                    const name = rawItems[i].trim();
                    const ability = parseFloat(rawItems[i+1].trim());
                    if (name && !isNaN(ability)) players.push({ name, ability });
                }
            }
            return players;
        }

        function parseCourts(text) {
            return text.split(',').map(c => c.trim()).filter(c => c.length > 0);
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        // --- SCHEDULING ENGINE ---
        function scheduleGroup(players, courts, timeSlots) {
            // If no players, return empty result
            if (players.length === 0) return null;
            if (courts.length === 0) throw "No courts defined for a group with players.";

            // Hour 1
            let pool1 = shuffle([...players]);
            // Sort by ability for balanced matches
            pool1.sort((a,b) => b.ability - a.ability);
            
            const res1 = createMatches(pool1, courts);
            
            // Hour 2 Logic:
            // Prioritize sitters from H1, then shuffle players from H1
            const playedNamesH1 = res1.matches.flat().map(p => p.name);
            const playedObjH1 = players.filter(p => playedNamesH1.includes(p.name));
            const pool2 = [...res1.sitOut, ...shuffle(playedObjH1)];
            
            // Sort Hour 2 pool by ability again for balance
            pool2.sort((a,b) => b.ability - a.ability);

            const res2 = createMatches(pool2, courts);

            return {
                time1: timeSlots[0],
                round1: res1,
                time2: timeSlots[1],
                round2: res2
            };
        }

        function createMatches(pool, courts) {
            const matches = [];
            const sitOut = [];
            const maxPlay = courts.length * 4;
            
            const playingPool = pool.slice(0, maxPlay);
            const sittingPool = pool.slice(maxPlay);
            sitOut.push(...sittingPool);

            let tempPool = [...playingPool];

            for(let i=0; i<courts.length; i++) {
                if(tempPool.length < 4) {
                    sitOut.push(...tempPool);
                    break;
                }
                // Matchmaking: Strongest/Weakest combos
                let p1 = tempPool.shift();
                let p2 = tempPool.shift();
                let p3 = tempPool.pop();
                let p4 = tempPool.pop();
                
                let teamA = shuffle([p1, p3]);
                let teamB = shuffle([p2, p4]);
                matches.push([...teamA, ...teamB]);
            }
            return { matches, sitOut };
        }

        // --- MAIN GENERATE ---
        function generateAllSchedules() {
            const errBox = document.getElementById('errorContainer');
            const outBox = document.getElementById('output');
            errBox.style.display = 'none';
            outBox.style.display = 'none';
            
            try {
                // 1. Get Inputs
                const p1Text = document.getElementById('playersG1').value;
                const c1Text = document.getElementById('courtsG1').value;
                const p2Text = document.getElementById('playersG2').value;
                const c2Text = document.getElementById('courtsG2').value;

                // 2. Save
                const saveData = { p1: p1Text, c1: c1Text, p2: p2Text, c2: c2Text };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));

                // 3. Process Group 1
                const players1 = parsePlayers(p1Text);
                const courts1 = parseCourts(c1Text);
                const result1 = scheduleGroup(players1, courts1, ["4:30 PM - 5:30 PM", "5:30 PM - 6:30 PM"]);

                // 4. Process Group 2
                const players2 = parsePlayers(p2Text);
                const courts2 = parseCourts(c2Text);
                const result2 = scheduleGroup(players2, courts2, ["5:30 PM - 6:30 PM", "6:30 PM - 7:30 PM"]);

                // 5. Build HTML
                let html = "";

                // Render Group 1
                if (result1) {
                    html += renderGroupHTML("Group 1 (Early Starters)", result1, courts1);
                }

                // Spacer
                if (result1 && result2) html += "<br><hr style='border-top: 3px double #003366;'><br>";

                // Render Group 2
                if (result2) {
                    html += renderGroupHTML("Group 2 (Late Starters)", result2, courts2);
                }

                if (html === "") throw "Please enter players in at least one group.";

                outBox.innerHTML = html;
                outBox.style.display = 'block';

            } catch(err) {
                errBox.innerText = err;
                errBox.style.display = 'block';
            }
        }

        function renderGroupHTML(groupTitle, data, courtNames) {
            let html = `<h2>${groupTitle}</h2>`;
            
            // Function to build a single table
            const buildTable = (time, roundData) => {
                let t = `<h3>${time}</h3>`;
                t += `<table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
                roundData.matches.forEach((m, idx) => {
                    let cName = courtNames[idx] || `C${idx+1}`;
                    t += `<tr>
                        <td style="font-weight:bold;">${cName}</td>
                        <td>${m[0].name} & ${m[1].name}</td>
                        <td>${m[2].name} & ${m[3].name}</td>
                    </tr>`;
                });
                if (roundData.sitOut.length > 0) {
                    t += `<tr><td class="sit-out" colspan="3">Sit Out: ${roundData.sitOut.map(p=>p.name).join(', ')}</td></tr>`;
                }
                t += `</table>`;
                return t;
            };

            html += buildTable(data.time1, data.round1);
            html += buildTable(data.time2, data.round2);
            return html;
        }

        function openShareView() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            
            if (outBox.style.display === 'none') {
                alert("Generate schedule first.");
                return;
            }

            const win = window.open("", "_blank");
            win.document.write(`
                <html>
                <head>
                    <title>Schedule ${dateStr}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; text-align: center; }
                        h1 { color: #003366; }
                        h2 { background-color: #003366; color: white; padding: 5px; margin-top: 30px; border-radius: 4px; }
                        h3 { color: #003366; margin-bottom: 5px; margin-top: 15px; }
                        table { width: 100%; max-width: 800px; margin: 0 auto; border-collapse: collapse; border: 2px solid #003366; }
                        th { background-color: #003366; color: white; padding: 8px; }
                        td { border: 1px solid #ccc; padding: 8px; }
                        .sit-out { background-color: #eef; font-weight: bold; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>ðŸŽ¾ Schedule - ${dateStr}</h1>
                    ${outBox.innerHTML}
                    <br><button onclick="window.print()">Print / PDF</button>
                </body>
                </html>
            `);
            win.document.close();
        }
    </script>
</body>
</html>
