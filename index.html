<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen's Club Tennis Scheduler</title>
    <style>
        /* BASE & RESET */
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
        }

        /* --- LAYOUT CONTAINERS --- */
        .main-wrapper { max-width: 1100px; margin: 0 auto; }
        
        /* The "Card" Look for Schedules */
        .schedule-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }
        
        .schedule-header {
            background-color: #003366; /* Queen's Navy */
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #bfa15f; /* Queen's Gold */
        }
        
        .schedule-header h2 { margin: 0; font-size: 1.8em; font-weight: 400; }
        .schedule-body { padding: 30px; }

        /* MODES UTILITY */
        .admin-only { display: block; } 
        .public-only { display: none; } 

        /* PUBLIC VIEW MODE */
        body.public-view .admin-only { display: none !important; }
        body.public-view .public-only { display: block !important; }
        body.public-view .schedule-card { display: block !important; margin: 40px auto; max-width: 800px; }

        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #003366; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 8px; text-align: center; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-box h2 { color: #003366; margin-top: 0; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: #003366; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-box button:hover { background: #002244; }
        .login-error { color: red; font-size: 0.9em; margin-top: 10px; display: none; }

        /* Header (Admin) */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { color: #003366; margin: 0; font-size: 1.8em; }
        .user-controls { display: flex; align-items: center; gap: 15px; }
        .user-email { font-size: 0.9em; color: #666; font-weight: bold; }
        .logout-btn { padding: 5px 10px; background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }

        /* Input Areas */
        .container-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-master { flex: 1; min-width: 300px; }
        .col-weekly { flex: 2; min-width: 400px; }

        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; font-weight: 500; }
        .master-header { background-color: #444; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; font-weight: 500; }

        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        input[type="date"], textarea, select { box-sizing: border-box; width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-family: inherit; }
        textarea { font-family: monospace; font-size: 14px; }

        /* Buttons */
        .button-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { flex: 1; padding: 12px; font-weight: bold; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
        .action-btn:hover { transform: translateY(-1px); }
        #btnGenerate { background-color: #003366; } 
        #btnPublish { background-color: #e65100; } 
        #btnWord { background-color: #2b5797; }
        #btnClear { background-color: #d9534f; color: white; padding: 5px 15px; font-size: 14px; border:none; border-radius: 4px; cursor: pointer; }

        /* Schedule Tables (Shared Styles) */
        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
        th { text-align: left; font-size: 12px; color: #888; text-transform: uppercase; padding: 8px 12px; border-bottom: 1px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 15px; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        td:first-child { font-weight: bold; color: #003366; width: 15%; }
        
        h2 { color: #003366; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; margin-bottom: 15px; }
        h3 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 10px; margin-top: 20px; letter-spacing: 1px; }

        .sit-out { background-color: #f8f9fa; color: #555; font-style: italic; border-radius: 6px; font-size: 14px; }

        /* Chips & Dragging */
        .player-chip { display: inline-block; background-color: #e7f3fe; border: 1px solid #003366; color: #003366; padding: 4px 8px; border-radius: 15px; margin: 2px; cursor: grab; font-weight: 500; }
        .player-chip:hover { background-color: #003366; color: white; }
        .player-chip:active { cursor: grabbing; }
        .over { transform: scale(1.1); background-color: #ffd700; border-color: #000; }
        .drag-hint { background-color: #e7f3fe; border-left: 6px solid #2196F3; margin-bottom: 15px; padding: 10px; font-size: 0.9em; }

        /* Tools */
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
        #dbStatus { font-size: 0.85em; color: green; font-weight: bold; margin-top: 5px; text-align: right; }
        #published-dashboard { background: #eef; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ccc; }
        .pub-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }

        /* Resolver */
        .resolver-box { background-color: #fff3cd; border: 2px solid #ffc107; padding: 20px; margin-top: 20px; border-radius: 8px; display: none; }
        .unknown-item { background: white; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .suggestion-btn { background-color: #17a2b8; color: white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer;}
        .add-btn { background-color: #28a745; color: white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer;}

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; text-align: center; border-radius: 8px; }
        .modal-link { background: #eee; padding: 10px; border: 1px dashed #ccc; word-break: break-all; margin: 15px 0; font-family: monospace; }
        .close-modal { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay" style="display:none;">
        <div class="login-box">
            <h2>üéæ Tennis Planner</h2>
            <p style="font-size:0.9em; color:#666;">Log in to manage.</p>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Log In</button>
            <div id="login-msg" class="login-error"></div>
        </div>
    </div>

    <div class="main-wrapper">
        <div id="app-container">
            
            <div class="header-row admin-only">
                <h1>üéæ Wednesday Staggered Schedule</h1>
                <div class="user-controls">
                    <span id="user-display" class="user-email"></span>
                    <button class="logout-btn" onclick="logout()">Sign Out</button>
                </div>
            </div>

            <div id="published-dashboard" class="admin-only" style="display:none;">
                <strong>üì° Published Schedules</strong>
                <div id="publishedList" style="margin-top:10px;">Loading...</div>
            </div>

            <div class="admin-only">
                <label for="sessionDate">Session Date:</label>
                <input type="date" id="sessionDate" onchange="saveDataToCloud()">

                <div class="container-flex" style="margin-top:20px;">
                    <div class="col-master">
                        <div class="group-container" style="background-color: #f9f9f9;">
                            <div class="master-header">üìÇ Master Player Bank</div>
                            <div class="help-text">Format: <strong>Name, Rating, M/W</strong></div>
                            <textarea id="masterList" rows="30" oninput="saveDataToCloud(); updateDBStatus();"></textarea>
                            <div id="dbStatus"></div>
                        </div>
                    </div>

                    <div class="col-weekly">
                        <div style="text-align: right; margin-bottom: 10px;">
                            <button id="btnClear" onclick="clearWeeklyInputs()">üóëÔ∏è Clear Groups</button>
                        </div>
                        <div class="group-container">
                            <div class="group-header">Group 1: Early (4:30 - 6:30)</div>
                            <label>Players:</label>
                            <textarea id="playersG1" rows="6" oninput="saveDataToCloud()"></textarea>
                            <label>Courts:</label>
                            <textarea id="courtsG1" rows="1" oninput="saveDataToCloud()">1, 2</textarea>
                        </div>
                        <div class="group-container">
                            <div class="group-header">Group 2: Late (5:30 - 7:30)</div>
                            <label>Players:</label>
                            <textarea id="playersG2" rows="10" oninput="saveDataToCloud()"></textarea>
                            <label>Courts:</label>
                            <textarea id="courtsG2" rows="1" oninput="saveDataToCloud()">3, 4, 5, 6</textarea>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button id="btnGenerate" class="action-btn" onclick="startGenerationProcess()">1. Generate</button>
                    <button id="btnPublish" class="action-btn" onclick="publishSchedule()">2. Publish to Web üåê</button>
                    <button id="btnWord" class="action-btn" onclick="downloadWordDoc()">3. Download Word</button>
                </div>
                
                <div id="errorContainer" class="error-box"></div>
                <div id="resolverContainer" class="resolver-box">
                    <div style="font-weight:bold; color:#856404; margin-bottom:10px;">‚ö†Ô∏è Unknown Players Detected</div>
                    <div id="resolverList"></div>
                </div>
            </div>
            
            <div id="schedule-container" class="schedule-card">
                <div class="schedule-header">
                    <h2>Order of Play</h2>
                    <div id="publicDateDisplay" style="font-size: 1.2em; opacity: 0.9; margin-top: 5px;"></div>
                </div>
                <div id="output" class="schedule-body"></div>
                <div class="public-only" style="text-align:center; padding: 20px; background:#fafafa; color:#999; font-size:0.8em; border-top:1px solid #eee;">
                    Tennis Scheduler by MakeMeFaster.com
                </div>
            </div>

        </div>
    </div>

    <div id="publishModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('publishModal').style.display='none'">&times;</span>
            <h2 style="color:#003366;">‚úÖ Schedule Published!</h2>
            <p>Share this link with your players:</p>
            <div class="modal-link" id="publishLink"></div>
            <button onclick="copyLink()" style="background:#003366; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Copy Link</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, push, remove, onValue, get, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZPyd_grTtcXGGBA3s7CQVGt-SXDm_QkA",
            authDomain: "project-8381867246864635545.firebaseapp.com",
            databaseURL: "https://project-8381867246864635545-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-8381867246864635545",
            storageBucket: "project-8381867246864635545.firebasestorage.app",
            messagingSenderId: "531514593264",
            appId: "1:531514593264:web:5ac9c140c374f63eb99735"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let isCloudLoading = false;

        window.login = login;
        window.logout = logout;
        window.saveDataToCloud = saveDataToCloud;
        window.clearWeeklyInputs = clearWeeklyInputs;
        window.publishSchedule = publishSchedule;
        window.deleteSchedule = deleteSchedule;
        window.copyLink = copyLink;
        window.openShareView = openShareView;
        window.downloadWordDoc = downloadWordDoc;

        // --- ROUTER ---
        const urlParams = new URLSearchParams(window.location.search);
        const publicId = urlParams.get('id');

        if (publicId) {
            // PUBLIC MODE
            document.body.classList.add('public-view');
            document.getElementById('app-container').style.display = 'block';
            
            const schedRef = ref(db, 'public_schedules/' + publicId);
            onValue(schedRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const dateObj = new Date(data.date);
                    const niceDate = dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    
                    document.getElementById('publicDateDisplay').innerText = niceDate;
                    document.getElementById('output').innerHTML = data.html;
                    document.getElementById('schedule-container').style.display = 'block';
                    
                    // Disable interactivity
                    let chips = document.querySelectorAll('.player-chip');
                    chips.forEach(c => { c.draggable = false; c.style.cursor = 'default'; });
                } else {
                    document.getElementById('app-container').innerHTML = "<h2 style='text-align:center; margin-top:50px; color:#666;'>Schedule not found.</h2>";
                }
            });
        } else {
            // ADMIN MODE
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    document.getElementById('user-display').innerText = user.email;
                    loadDataFromCloud();
                    loadPublishedList();
                } else {
                    currentUser = null;
                    document.getElementById('login-overlay').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                }
            });
        }

        async function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (error) { document.getElementById('login-msg').innerText = error.message; document.getElementById('login-msg').style.display='block'; }
        }

        async function logout() { await signOut(auth); window.location.reload(); }

        function loadDataFromCloud() {
            if (!currentUser) return;
            isCloudLoading = true;
            const userRef = ref(db, 'users/' + currentUser.uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.master) document.getElementById('masterList').value = data.master;
                    if (data.p1) document.getElementById('playersG1').value = data.p1;
                    if (data.c1) document.getElementById('courtsG1').value = data.c1;
                    if (data.p2) document.getElementById('playersG2').value = data.p2;
                    if (data.c2) document.getElementById('courtsG2').value = data.c2;
                    if (data.date) document.getElementById('sessionDate').value = data.date;
                    window.updateDBStatus();
                } else { setNextWednesday(); }
                isCloudLoading = false;
            });
        }

        function saveDataToCloud() {
            if (!currentUser || isCloudLoading) return;
            const data = {
                master: document.getElementById('masterList').value,
                p1: document.getElementById('playersG1').value,
                c1: document.getElementById('courtsG1').value,
                p2: document.getElementById('playersG2').value,
                c2: document.getElementById('courtsG2').value,
                date: document.getElementById('sessionDate').value
            };
            set(ref(db, 'users/' + currentUser.uid), data);
        }

        function clearWeeklyInputs() {
            if(confirm("Clear weekly inputs? Master Bank will remain.")) {
                document.getElementById('playersG1').value = "";
                document.getElementById('playersG2').value = "";
                document.getElementById('resolverContainer').style.display = 'none';
                document.getElementById('schedule-container').style.display = 'none';
                saveDataToCloud();
            }
        }

        function setNextWednesday() {
            const dateInput = document.getElementById('sessionDate');
            if(dateInput.value) return; 
            const today = new Date();
            let diff = (3 + 7 - today.getDay()) % 7;
            if (diff === 0) diff = 7; 
            const nextWed = new Date(today);
            nextWed.setDate(today.getDate() + diff);
            dateInput.value = nextWed.toISOString().split('T')[0];
        }

        async function publishSchedule() {
            const outBox = document.getElementById('output');
            if(document.getElementById('schedule-container').style.display === 'none') return alert("Generate first.");
            
            const dateStr = document.getElementById('sessionDate').value;
            const dateObj = new Date(dateStr);
            const niceDate = dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            const q = query(ref(db, 'public_schedules'), orderByChild('date'), equalTo(dateStr));
            const snapshot = await get(q);

            let targetRef;
            if (snapshot.exists()) {
                if(!confirm(`‚ö†Ô∏è A schedule for ${niceDate} ALREADY exists.\n\nClick OK to OVERWRITE it (keeps the same link).\nClick Cancel to change the date.`)) { return; }
                const existingKey = Object.keys(snapshot.val())[0];
                targetRef = ref(db, 'public_schedules/' + existingKey);
            } else {
                targetRef = push(ref(db, 'public_schedules'));
            }

            let cleanHTML = outBox.innerHTML.replace(/draggable="true"/g, "").replace(/cursor: grab;/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");

            set(targetRef, { 
                date: dateStr, 
                html: cleanHTML, 
                created: Date.now() 
            }).then(() => {
                const link = window.location.href.split('?')[0] + "?id=" + targetRef.key;
                document.getElementById('publishLink').innerText = link;
                document.getElementById('publishModal').style.display = 'block';
            });
        }

        function loadPublishedList() {
            const listRef = ref(db, 'public_schedules');
            onValue(listRef, (snapshot) => {
                const list = document.getElementById('publishedList');
                list.innerHTML = "";
                if(!snapshot.exists()) { list.innerHTML = "No active schedules."; return; }
                snapshot.forEach(child => {
                    const data = child.val();
                    const key = child.key;
                    const url = window.location.href.split('?')[0] + "?id=" + key;
                    const dateObj = new Date(data.date);
                    const niceDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    
                    const div = document.createElement('div');
                    div.className = 'pub-item';
                    div.innerHTML = `<div class="pub-link">üìÖ ${niceDate} <br><a href="${url}" target="_blank" style="font-size:0.8em; color:#666;">${url}</a></div><button class="del-btn" onclick="deleteSchedule('${key}')">Delete</button>`;
                    list.appendChild(div);
                });
            });
        }

        function deleteSchedule(key) {
            if(confirm("Delete this schedule?")) { remove(ref(db, 'public_schedules/' + key)); }
        }

        function copyLink() {
            const text = document.getElementById('publishLink').innerText;
            navigator.clipboard.writeText(text).then(() => alert("Copied!"));
        }

        // --- PREMIUM SHARE VIEW ---
        function openShareView() {
            const outBox = document.getElementById('output');
            if(document.getElementById('schedule-container').style.display === 'none') return alert("Generate first.");
            
            let cleanHTML = outBox.innerHTML
                .replace(/draggable="true"/g, "")
                .replace(/cursor: grab;/g, "")
                .replace(/<div class="drag-hint">.*?<\/div>/, "");

            const dateVal = document.getElementById('sessionDate').value;
            const dateObj = new Date(dateVal);
            const niceDate = dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            const win = window.open("", "_blank");
            win.document.write(`
                <!DOCTYPE html><html><head><title>Order of Play - ${niceDate}</title>
                <style>
                    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 40px 20px; color: #1a1a1a; -webkit-print-color-adjust: exact; }
                    .container { max-width: 800px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
                    .header { background-color: #003366; color: white; padding: 30px; text-align: center; border-bottom: 4px solid #bfa15f; }
                    .header h1 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
                    .header h2 { margin: 10px 0 0 0; font-size: 18px; font-weight: 400; opacity: 0.9; }
                    .content { padding: 40px; }
                    h2 { color: #003366; font-size: 18px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; margin-bottom: 15px; }
                    h2:first-child { margin-top: 0; }
                    h3 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 10px; margin-top: 20px; letter-spacing: 1px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    th { text-align: left; font-size: 12px; color: #888; text-transform: uppercase; padding: 8px 12px; border-bottom: 1px solid #ddd; }
                    td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 15px; }
                    tr:last-child td { border-bottom: none; }
                    td:first-child { font-weight: bold; color: #003366; width: 15%; }
                    .player-chip { display: inline-block; padding: 0; font-weight: 500; color: #333; }
                    .sit-out { background-color: #f8f9fa; color: #555; font-style: italic; border-radius: 6px; font-size: 14px; }
                    .footer { text-align: center; padding: 20px; font-size: 12px; color: #999; background: #fafafa; border-top: 1px solid #eee; }
                    .no-print { text-align: center; margin-top: 30px; }
                    button { background-color: #003366; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-size: 14px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,51,102,0.2); transition: transform 0.1s; }
                    button:hover { transform: translateY(-1px); }
                    @media print { body { background: white; padding: 0; } .container { box-shadow: none; max-width: 100%; width: 100%; } .no-print { display: none; } .header { -webkit-print-color-adjust: exact; } }
                </style></head><body>
                <div class="container"><div class="header"><h1>Order of Play</h1><h2>${niceDate}</h2></div><div class="content">${cleanHTML}</div><div class="footer">Tennis Scheduler by MakeMeFaster.com</div></div>
                <div class="no-print"><button onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button></div>
                </body></html>
            `);
            win.document.close();
        }
    </script>

    <script>
        function getMasterDatabase() {
            const masterText = document.getElementById('masterList').value;
            const db = {};
            const lines = masterText.split(/\r?\n/);
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const ability = parseFloat(parts[1].trim());
                    let gender = 'U';
                    if(parts.length >= 3) gender = parts[2].trim().toUpperCase();
                    if(name && !isNaN(ability)) {
                        db[name.toLowerCase()] = { name: name, ability: ability, gender: gender };
                    }
                }
            });
            return db;
        }

        function updateDBStatus() {
            const db = getMasterDatabase();
            const count = Object.keys(db).length;
            document.getElementById('dbStatus').innerText = `‚úÖ Cloud Synced: ${count} players`;
        }

        // --- SMARTER FUZZY MATCHING ---
        function getSimilarity(s1, s2) {
            let longer = s1; let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength == 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            let costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function findClosestMatch(inputName, dbKeys) {
            const lowerInput = inputName.toLowerCase();
            let bestMatch = null;
            let highestScore = 0;
            dbKeys.forEach(key => {
                const lowerKey = key.toLowerCase();
                let score = 0;
                if (lowerKey.startsWith(lowerInput)) score = 0.95;
                else if (lowerKey.includes(lowerInput)) score = 0.85;
                else { score = getSimilarity(lowerInput, lowerKey); }
                if (score > highestScore) { highestScore = score; bestMatch = key; }
            });
            return highestScore > 0.5 ? bestMatch : null;
        }

        // --- PRE-CHECK ---
        function startGenerationProcess() {
            document.getElementById('resolverContainer').style.display = 'none';
            document.getElementById('schedule-container').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';

            const p1 = document.getElementById('playersG1').value;
            const p2 = document.getElementById('playersG2').value;
            const db = getMasterDatabase();
            const unknowns = [];

            const scan = (text, fid) => {
                text.split(/[\r\n,]+/).forEach(token => {
                    token = token.trim();
                    if(!token || /\d/.test(token)) return; 
                    if (!db[token.toLowerCase()]) {
                        if(!unknowns.find(u => u.name === token)) unknowns.push({name:token, id:fid});
                    }
                });
            };
            scan(p1, 'playersG1'); scan(p2, 'playersG2');

            if (unknowns.length > 0) showResolver(unknowns, db);
            else generateAllSchedules();
        }

        function showResolver(unknowns, db) {
            const list = document.getElementById('resolverList');
            list.innerHTML = "";
            const keys = Object.keys(db);
            unknowns.forEach(u => {
                const closestKey = findClosestMatch(u.name, keys);
                let suggestionHtml = "";
                if (closestKey) {
                    const properName = db[closestKey].name;
                    suggestionHtml = `<button class="suggestion-btn" onclick="fixTypo('${u.name}', '${properName}', '${u.id}')">Fix: <strong>${properName}</strong></button> <span style="font-size:0.9em; margin:0 5px;">or</span> `;
                }
                const div = document.createElement('div');
                div.className = 'unknown-item';
                div.innerHTML = `<span style="font-weight:bold; color:#d9534f; min-width:80px;">"${u.name}"</span>${suggestionHtml}<div style="display:flex; gap:5px; align-items:center;"><input type="number" id="r_${u.name}" placeholder="Rate" step="0.5" style="width:60px; padding:5px;"><select id="g_${u.name}" style="padding:5px;"><option value="M">M</option><option value="W">W</option></select><button class="add-btn" onclick="addToBank('${u.name}')">Add New</button></div>`;
                list.appendChild(div);
            });
            document.getElementById('resolverContainer').style.display = 'block';
        }

        window.fixTypo = function(bad, good, id) {
            const el = document.getElementById(id);
            el.value = el.value.replace(new RegExp(`\\b${bad}\\b`, 'g'), good);
            saveDataToCloud(); 
            startGenerationProcess();
        }

        window.addToBank = function(name) {
            const r = document.getElementById('r_'+name).value;
            const g = document.getElementById('g_'+name).value;
            if(!r) return alert("Enter rating");
            const master = document.getElementById('masterList');
            master.value += `\n${name}, ${r}, ${g}`;
            saveDataToCloud(); 
            startGenerationProcess();
        }

        // --- MERGED MIXER LOGIC ---
        function parse(txt, db) {
            const res = [];
            txt.split(/[\r\n,]+/).forEach(t => {
                t = t.trim();
                if(!t) return;
                if(db[t.toLowerCase()]) res.push(db[t.toLowerCase()]);
                else if (/\d/.test(t)) {}
                else res.push({name: t+" (?)", ability:3, gender:'U'}); 
            });
            return res;
        }
        function parseC(t) { return t.replace(/[\r\n]+/g, ',').split(',').map(c=>c.trim()).filter(c=>c.length>0); }
        function shuffle(a) { return a.sort(()=>Math.random()-0.5); }
        function getPairKey(a,b) { return [a.name, b.name].sort().join('|'); }

        function determinePool(pool, cap) {
            if(pool.length <= cap) return {playing: pool, sitting: []};
            const needed = pool.length - cap;
            // Robin Hood: Prioritize 5s to sit
            const fives = shuffle(pool.filter(p=>p.ability>=5));
            const others = shuffle(pool.filter(p=>p.ability<5)).sort((a,b)=>b.ability-a.ability);
            
            const sit = [];
            while(sit.length < needed && fives.length) sit.push(fives.pop());
            while(sit.length < needed && others.length) sit.push(others.shift());
            return { playing: [...fives, ...others], sitting: sit };
        }

        function createMatches(pool, courts, hist) {
            pool.sort((a,b)=>b.ability-a.ability);
            const matches = [];
            let temp = [...pool];
            for(let i=0; i<courts.length; i++) {
                if(temp.length < 4) break;
                let p1 = temp.shift(), p2 = temp.shift(), p3 = temp.shift(), p4 = temp.shift();
                
                const combos = [[[0,1],[2,3]], [[0,2],[1,3]], [[0,3],[1,2]]];
                let bestSc = -9999, bestC = null;
                const set = [p1,p2,p3,p4];

                combos.forEach(c => {
                    const t1a=set[c[0][0]], t1b=set[c[0][1]], t2a=set[c[1][0]], t2b=set[c[1][1]];
                    let sc = 0;
                    if(hist.has(getPairKey(t1a,t1b))) sc -= 10000;
                    if(hist.has(getPairKey(t2a,t2b))) sc -= 10000;
                    const m1 = (t1a.gender!=t1b.gender && t1a.gender!='U' && t1b.gender!='U');
                    const m2 = (t2a.gender!=t2b.gender && t2a.gender!='U' && t2b.gender!='U');
                    if(m1 && m2) sc += 500; else if(m1||m2) sc+=50;
                    sc -= Math.abs((t1a.ability+t1b.ability)-(t2a.ability+t2b.ability)) * 20;
                    if(sc > bestSc) { bestSc = sc; bestC = [t1a,t1b,t2a,t2b]; }
                });
                matches.push(bestC);
            }
            return { matches: matches, sitOut: [] }; // Sitouts handled by wrapper
        }

        function generateAllSchedules() {
            const p1 = document.getElementById('playersG1').value;
            const c1 = document.getElementById('courtsG1').value;
            const p2 = document.getElementById('playersG2').value;
            const c2 = document.getElementById('courtsG2').value;
            const db = getMasterDatabase();

            const players1 = parse(p1, db);
            const courts1 = parseC(c1);
            const players2 = parse(p2, db);
            const courts2 = parseC(c2);

            // 1. HOUR 1
            const cap1 = courts1.length * 4;
            const sel1 = determinePool([...players1], cap1);
            const res1 = createMatches(sel1.playing, courts1, new Set());
            res1.sitOut = sel1.sitting;
            
            const hist = new Set();
            res1.matches.forEach(m => { hist.add(getPairKey(m[0], m[1])); hist.add(getPairKey(m[2], m[3])); });

            // 2. MIXER HOUR
            const allMixerPlayers = [...players1, ...players2];
            const allMixerCourts = [...courts1, ...courts2];
            const capMix = allMixerCourts.length * 4;

            const g1Sitters = [...res1.sitOut];
            const others = allMixerPlayers.filter(p => !g1Sitters.includes(p));
            
            let playingMix = [...g1Sitters];
            let sittingMix = [];
            
            const neededMix = capMix - playingMix.length;
            const selectionMix = determinePool(others, neededMix); 
            playingMix = [...playingMix, ...selectionMix.playing];
            sittingMix = selectionMix.sitting;

            const resMix = createMatches(playingMix, allMixerCourts, hist);
            resMix.sitOut = sittingMix;

            resMix.matches.forEach(m => { hist.add(getPairKey(m[0], m[1])); hist.add(getPairKey(m[2], m[3])); });

            // 3. HOUR 3
            const cap3 = courts2.length * 4;
            const g2SittersMix = sittingMix.filter(p => players2.includes(p)); 
            const g2Others = players2.filter(p => !g2SittersMix.includes(p));

            let playing3 = [...g2SittersMix];
            let sitting3 = [];
            const needed3 = cap3 - playing3.length;
            const selection3 = determinePool(g2Others, needed3);
            playing3 = [...playing3, ...selection3.playing];
            sitting3 = selection3.sitting;

            const res3 = createMatches(playing3, courts2, hist);
            res3.sitOut = sitting3;

            // RENDER
            let h = "<div class='drag-hint'>üí° <strong>Tip:</strong> Drag names to swap. Click <strong>Publish</strong> when done.</div>";
            h += renderGroup("4:30 PM - 5:30 PM (Early Birds)", res1, courts1);
            h += "<br><hr style='border-top:3px double #003366'><br>";
            h += renderGroup("5:30 PM - 6:30 PM (The Mixer)", resMix, allMixerCourts);
            h += "<br><hr style='border-top:3px double #003366'><br>";
            h += renderGroup("6:30 PM - 7:30 PM (Late Finishers)", res3, courts2);

            const out = document.getElementById('output');
            out.innerHTML = h;
            document.getElementById('schedule-container').style.display = 'block';
            enableDrag();
        }

        function renderGroup(time, r, cNames) {
            let t = `<h3>${time}</h3><table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
            r.matches.forEach((m, i) => {
                t += `<tr><td style="font-weight:bold;">${cNames[i]||(i+1)}</td><td>${chip(m[0])} & ${chip(m[1])}</td><td>${chip(m[2])} & ${chip(m[3])}</td></tr>`;
            });
            if(r.sitOut.length) t+= `<tr><td class="sit-out" colspan="3">Sit Out: ${r.sitOut.map(chip).join(' ')}</td></tr>`;
            return t + "</table>";
        }

        function chip(p) { return `<span class="player-chip" draggable="true">${p.name}</span>`; }

        function enableDrag() {
            let dragSrc = null;
            document.querySelectorAll('.player-chip').forEach(item => {
                item.addEventListener('dragstart', function(e) { dragSrc=this; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/html', this.innerHTML); this.style.opacity='0.4'; });
                item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
                item.addEventListener('drop', function(e) { e.stopPropagation(); if(dragSrc!=this){ const t=this.innerHTML; this.innerHTML=dragSrc.innerHTML; dragSrc.innerHTML=t; } return false; });
                item.addEventListener('dragend', function() { this.style.opacity='1'; });
            });
        }

        function downloadWordDoc() {
            const outBox = document.getElementById('output');
            if(document.getElementById('schedule-container').style.display === 'none') return alert("Generate first.");
            let cleanHTML = outBox.innerHTML.replace(/<span class="player-chip"[^>]*>/g, "").replace(/<\/span>/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");
            var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Schedule</title><style>body{font-family:sans-serif;}table{width:100%;border-collapse:collapse;}td,th{border:1px solid #000;padding:5px;text-align:center;}th{background:#003366;color:white;}</style></head><body>" + c + "</body></html>";
            const b = new Blob([h], {type: 'application/msword'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = "schedule.doc"; document.body.appendChild(a); a.click();
        }
    </script>
</body>
</html>

