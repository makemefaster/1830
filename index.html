<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wednesday Staggered Tennis Schedule</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 10px; }
        h2 { color: #003366; margin-top: 30px; border-bottom: 1px solid #ccc; }
        
        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }

        input, textarea, button { 
            box-sizing: border-box; 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-family: inherit;
        }
        
        textarea { font-family: monospace; }
        
        /* Button Styles */
        .button-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        button { 
            width: auto; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            border: none;
            padding: 12px 24px;
            flex: 1;
        }
        
        #btnGenerate { background-color: #003366; color: white; } /* Navy */
        #btnGenerate:hover { background-color: #002244; }
        
        #btnShare { background-color: #4CAF50; color: white; } /* Green */
        #btnShare:hover { background-color: #45a049; }

        #btnWord { background-color: #2b5797; color: white; } /* Word Blue */
        #btnWord:hover { background-color: #1e3f6f; }

        /* Output Styles */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #003366; font-size: 0.9em; }
        th { background-color: #003366; color: white; padding: 8px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <h1>ðŸŽ¾ Wednesday Staggered Schedule</h1>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <div class="group-container">
        <div class="group-header">Group 1: Early Starters (4:30 PM - 6:30 PM)</div>
        
        <label for="playersG1">Players (Name, Ability, Gender):</label>
        <div class="help-text">One player per line OR comma separated.<br>Format: <strong>Name, Ability, M/W</strong></div>
        <textarea id="playersG1" rows="10">Alex, 4, M
Ben, 3, M
Chloe, 5, W
David, 2, M
Emily, 3, W
Finn, 4, M
Grace, 2, W
Hugo, 5, M</textarea>
        
        <label for="courtsG1">Courts (4:30 & 5:30):</label>
        <textarea id="courtsG1" rows="1">1, 2</textarea>
    </div>

    <div class="group-container">
        <div class="group-header">Group 2: Late Starters (5:30 PM - 7:30 PM)</div>
        
        <label for="playersG2">Players (Name, Ability, Gender):</label>
        <textarea id="playersG2" rows="18">Isaac, 3, M
Jane, 4, W
Karl, 2, M
Leah, 3, W
Mark, 5, M
Nina, 4, W
Owen, 2, M
Pam, 3, W
Quinn, 4, M
Rob, 3, M
Steve, 4, M
Tim, 2, M
Ursula, 3, W
Victor, 5, M
Will, 4, M
Xena, 3, W</textarea>
        
        <label for="courtsG2">Courts (5:30 & 6:30):</label>
        <textarea id="courtsG2" rows="1">3, 4, 5, 6</textarea>
    </div>

    <div class="button-row">
        <button id="btnGenerate" onclick="generateAllSchedules()">1. Generate Schedule</button>
        <button id="btnShare" onclick="openShareView()">2. View / Print PDF</button>
        <button id="btnWord" onclick="downloadWordDoc()">3. Download Word Doc</button>
    </div>

    <div id="errorContainer" class="error-box"></div>
    <div id="output" class="schedule-output"></div>

    <script>
        const STORAGE_KEY = 'tennis_staggered_v4_newlines';

        // --- INITIALIZATION ---
        window.onload = function() {
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; 
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; 
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch(e) {}

            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('playersG1').value = data.p1 || "";
                    document.getElementById('courtsG1').value = data.c1 || "";
                    document.getElementById('playersG2').value = data.p2 || "";
                    document.getElementById('courtsG2').value = data.c2 || "";
                }
            } catch(e) {}
        };

        // --- IMPROVED PARSING (Handles New Lines AND Commas) ---
        function parsePlayers(text) {
            // 1. Replace all newlines with commas
            // 2. Split by comma
            // 3. Trim whitespace from every item
            // 4. Filter out empty strings
            const tokens = text.replace(/[\r\n]+/g, ',') 
                               .split(',')
                               .map(t => t.trim())
                               .filter(t => t.length > 0);

            const players = [];
            
            // Loop through tokens 3 at a time (Name, Ability, Gender)
            for (let i = 0; i < tokens.length; i += 3) {
                // Ensure we at least have Name and Ability
                if (tokens[i] && tokens[i+1]) {
                    const name = tokens[i];
                    const ability = parseFloat(tokens[i+1]);
                    
                    // Check 3rd token for Gender, default to 'U' if missing or if end of list
                    let gender = 'U';
                    if (tokens[i+2]) {
                        gender = tokens[i+2].toUpperCase();
                    }

                    if (name && !isNaN(ability)) {
                        players.push({ name, ability, gender });
                    }
                }
            }
            return players;
        }

        function parseCourts(text) {
            return text.replace(/[\r\n]+/g, ',')
                       .split(',')
                       .map(c => c.trim())
                       .filter(c => c.length > 0);
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        // --- SCHEDULING ENGINE ---
        
        function getPairKey(p1, p2) {
            return [p1.name, p2.name].sort().join('|');
        }

        function scheduleGroup(players, courts, timeSlots) {
            if (players.length === 0) return null;
            if (courts.length === 0) throw "No courts defined for a group with players.";

            // --- HOUR 1 ---
            let pool1 = shuffle([...players]);
            pool1.sort((a,b) => b.ability - a.ability); 
            
            const res1 = createMatches(pool1, courts, new Set());
            
            const history = new Set();
            res1.matches.forEach(m => {
                history.add(getPairKey(m[0], m[1]));
                history.add(getPairKey(m[2], m[3]));
            });

            // --- HOUR 2 ---
            const playedNamesH1 = res1.matches.flat().map(p => p.name);
            const playedObjH1 = players.filter(p => playedNamesH1.includes(p.name));
            const pool2 = [...res1.sitOut, ...shuffle(playedObjH1)];
            
            pool2.sort((a,b) => b.ability - a.ability);

            const res2 = createMatches(pool2, courts, history);

            return {
                time1: timeSlots[0],
                round1: res1,
                time2: timeSlots[1],
                round2: res2
            };
        }

        function createMatches(pool, courts, partnerHistory) {
            const matches = [];
            const sitOut = [];
            const maxPlay = courts.length * 4;
            
            const playingPool = pool.slice(0, maxPlay);
            const sittingPool = pool.slice(maxPlay);
            sitOut.push(...sittingPool);

            let tempPool = [...playingPool];

            for(let i=0; i<courts.length; i++) {
                if(tempPool.length < 4) {
                    sitOut.push(...tempPool);
                    break;
                }
                
                let p1 = tempPool.shift();
                let p2 = tempPool.shift();
                let p3 = tempPool.shift(); 
                let p4 = tempPool.shift();
                
                const courtPlayers = [p1, p2, p3, p4];

                const combos = [
                    [[0,1], [2,3]],
                    [[0,2], [1,3]],
                    [[0,3], [1,2]]
                ];

                let bestScore = -9999;
                let bestCombo = null;

                combos.forEach(combo => {
                    const t1a = courtPlayers[combo[0][0]];
                    const t1b = courtPlayers[combo[0][1]];
                    const t2a = courtPlayers[combo[1][0]];
                    const t2b = courtPlayers[combo[1][1]];

                    let score = 0;

                    // 1. History Check
                    if (partnerHistory.has(getPairKey(t1a, t1b))) score -= 5000;
                    if (partnerHistory.has(getPairKey(t2a, t2b))) score -= 5000;

                    // 2. Mixed Doubles Check
                    const t1Mixed = (t1a.gender !== t1b.gender && t1a.gender !== 'U' && t1b.gender !== 'U');
                    const t2Mixed = (t2a.gender !== t2b.gender && t2a.gender !== 'U' && t2b.gender !== 'U');

                    if (t1Mixed && t2Mixed) score += 100; 
                    else if (t1Mixed || t2Mixed) score += 20;

                    // 3. Ability Balance
                    const t1Sum = t1a.ability + t1b.ability;
                    const t2Sum = t2a.ability + t2b.ability;
                    const diff = Math.abs(t1Sum - t2Sum);
                    
                    score -= (diff * 5); 

                    if (score > bestScore) {
                        bestScore = score;
                        bestCombo = [t1a, t1b, t2a, t2b];
                    }
                });

                matches.push(bestCombo);
            }
            return { matches, sitOut };
        }

        // --- MAIN GENERATE ---
        function generateAllSchedules() {
            const errBox = document.getElementById('errorContainer');
            const outBox = document.getElementById('output');
            errBox.style.display = 'none';
            outBox.style.display = 'none';
            
            try {
                const p1Text = document.getElementById('playersG1').value;
                const c1Text = document.getElementById('courtsG1').value;
                const p2Text = document.getElementById('playersG2').value;
                const c2Text = document.getElementById('courtsG2').value;

                const saveData = { p1: p1Text, c1: c1Text, p2: p2Text, c2: c2Text };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));

                const players1 = parsePlayers(p1Text);
                const courts1 = parseCourts(c1Text);
                const result1 = scheduleGroup(players1, courts1, ["4:30 PM - 5:30 PM", "5:30 PM - 6:30 PM"]);

                const players2 = parsePlayers(p2Text);
                const courts2 = parseCourts(c2Text);
                const result2 = scheduleGroup(players2, courts2, ["5:30 PM - 6:30 PM", "6:30 PM - 7:30 PM"]);

                let html = "";
                if (result1) html += renderGroupHTML("Group 1 (Early Starters)", result1, courts1);
                if (result1 && result2) html += "<br><hr style='border-top: 3px double #003366;'><br>";
                if (result2) html += renderGroupHTML("Group 2 (Late Starters)", result2, courts2);

                if (html === "") throw "Please enter valid players (Name, Ability, Gender) in at least one group.";

                outBox.innerHTML = html;
                outBox.style.display = 'block';

            } catch(err) {
                errBox.innerText = err;
                errBox.style.display = 'block';
            }
        }

        function renderGroupHTML(groupTitle, data, courtNames) {
            let html = `<h2>${groupTitle}</h2>`;
            const buildTable = (time, roundData) => {
                let t = `<h3>${time}</h3>`;
                t += `<table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
                roundData.matches.forEach((m, idx) => {
                    let cName = courtNames[idx] || `C${idx+1}`;
                    t += `<tr><td style="font-weight:bold;">${cName}</td><td>${m[0].name} & ${m[1].name}</td><td>${m[2].name} & ${m[3].name}</td></tr>`;
                });
                if (roundData.sitOut.length > 0) {
                    t += `<tr><td class="sit-out" colspan="3">Sit Out: ${roundData.sitOut.map(p=>p.name).join(', ')}</td></tr>`;
                }
                t += `</table>`;
                return t;
            };
            html += buildTable(data.time1, data.round1);
            html += buildTable(data.time2, data.round2);
            return html;
        }

        // --- VIEW SHAREABLE PAGE (PDF) ---
        function openShareView() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            
            if (outBox.style.display === 'none') { alert("Generate schedule first."); return; }

            const win = window.open("", "_blank");
            win.document.write(`
                <html>
                <head>
                    <title>Schedule ${dateStr}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; text-align: center; }
                        h1 { color: #003366; }
                        h2 { background-color: #003366; color: white; padding: 5px; margin-top: 30px; border-radius: 4px; }
                        h3 { color: #003366; margin-bottom: 5px; margin-top: 15px; }
                        table { width: 100%; max-width: 800px; margin: 0 auto; border-collapse: collapse; border: 2px solid #003366; }
                        th { background-color: #003366; color: white; padding: 8px; }
                        td { border: 1px solid #ccc; padding: 8px; }
                        .sit-out { background-color: #eef; font-weight: bold; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>ðŸŽ¾ Schedule - ${dateStr}</h1>
                    ${outBox.innerHTML}
                    <br><button onclick="window.print()">Print / PDF</button>
                </body>
                </html>
            `);
            win.document.close();
        }

        // --- EXPORT TO WORD ---
        function downloadWordDoc() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            
            if (outBox.style.display === 'none') { alert("Generate schedule first."); return; }

            var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                         "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                         "xmlns='http://www.w3.org/TR/REC-html40'>" +
                         "<head><meta charset='utf-8'><title>Tennis Schedule</title>";
            
            header += "<style>";
            header += "body { font-family: Arial, sans-serif; }";
            header += "h1, h2, h3 { color: #003366; }";
            header += "h2 { background-color: #003366; color: white; padding: 5px; }";
            header += "table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }";
            header += "td, th { border: 1px solid #003366; padding: 8px; text-align: center; }";
            header += "th { background-color: #003366; color: white; }";
            header += ".sit-out { background-color: #eef; font-weight: bold; }";
            header += "</style>";
            header += "</head><body>";
            
            header += "<h1>ðŸŽ¾ Wednesday Schedule - " + dateStr + "</h1>";

            var footer = "</body></html>";
            var sourceHTML = header + outBox.innerHTML + footer;

            var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            var fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'tennis_schedule_' + dateStr + '.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }
    </script>
</body>
</html>
