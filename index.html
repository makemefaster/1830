<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wednesday Staggered Tennis Schedule</title>
    <style>
        /* Queen's Club Style - Blue & White */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        
        /* Header Layout */
        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #003366; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { color: #003366; margin: 0; }
        
        .data-controls { display: flex; gap: 10px; }
        .data-btn { font-size: 13px; padding: 5px 10px; background: #eee; border: 1px solid #ccc; cursor: pointer; border-radius: 4px; }
        .data-btn:hover { background: #ddd; }

        h2 { color: #003366; margin-top: 30px; border-bottom: 1px solid #ccc; }
        
        label { font-weight: bold; display: block; margin-top: 15px; color: #003366; }
        .help-text { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
        
        /* Layout */
        .container-flex { display: flex; gap: 20px; flex-wrap: wrap; }
        .col-master { flex: 1; min-width: 300px; border-right: 2px dashed #ccc; padding-right: 20px; }
        .col-weekly { flex: 2; min-width: 400px; }

        .group-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .group-header { background-color: #003366; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }
        .master-header { background-color: #444; color: white; padding: 10px; border-radius: 4px 4px 0 0; margin: -20px -20px 20px -20px; font-size: 1.2em; }

        input, textarea, button, select { 
            box-sizing: border-box; 
            width: 100%; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            font-family: inherit;
        }
        
        textarea { font-family: monospace; font-size: 14px; }
        
        /* Button Styles */
        .button-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        button { 
            width: auto; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            border: none;
            padding: 12px 24px;
            flex: 1;
        }
        
        #btnGenerate { background-color: #003366; color: white; } 
        #btnGenerate:hover { background-color: #002244; }
        #btnShare { background-color: #4CAF50; color: white; } 
        #btnShare:hover { background-color: #45a049; }
        #btnWord { background-color: #2b5797; color: white; }
        #btnWord:hover { background-color: #1e3f6f; }
        #btnClear { background-color: #d9534f; color: white; flex: 0 0 auto; }
        #btnClear:hover { background-color: #c9302c; }

        /* Output Styles */
        .schedule-output { background: white; padding: 20px; margin-top: 20px; border: 1px solid #ddd; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #003366; font-size: 0.9em; }
        th { background-color: #003366; color: white; padding: 8px; text-align: center; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .sit-out { background-color: #eef; color: #003366; font-weight: bold; }
        
        /* INDIVIDUAL DRAG AND DROP STYLES */
        .player-chip {
            display: inline-block;
            background-color: #e7f3fe;
            border: 1px solid #003366;
            color: #003366;
            padding: 4px 8px;
            border-radius: 15px;
            margin: 2px;
            cursor: grab;
            transition: all 0.2s;
            font-weight: 500;
        }
        .player-chip:hover { background-color: #003366; color: white; }
        .player-chip:active { cursor: grabbing; }
        .over { transform: scale(1.1); background-color: #ffd700; border-color: #000; }

        /* UNKNOWN PLAYER RESOLVER STYLES */
        .resolver-box {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none; 
        }
        .resolver-title { font-weight: bold; font-size: 1.2em; color: #856404; margin-bottom: 10px; }
        .unknown-item {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .unknown-name { font-weight: bold; color: #d9534f; min-width: 100px; }
        .suggestion-btn { background-color: #17a2b8; color: white; padding: 5px 10px; font-size: 14px; flex: 0; }
        .add-btn { background-color: #28a745; color: white; padding: 5px 10px; font-size: 14px; flex: 0; }
        
        .drag-hint { background-color: #e7f3fe; border-left: 6px solid #2196F3; margin-bottom: 15px; padding: 10px; font-size: 0.9em; }
        .error-box { background-color: #ffe6e6; color: #d8000c; padding: 10px; border: 1px solid #d8000c; margin-top: 20px; display: none; }
        #dbStatus { font-size: 0.85em; color: green; font-weight: bold; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>üéæ Wednesday Staggered Schedule</h1>
        <div class="data-controls">
            <button class="data-btn" onclick="backupData()">‚¨áÔ∏è Backup Data</button>
            <button class="data-btn" onclick="document.getElementById('restoreInput').click()">‚¨ÜÔ∏è Restore Data</button>
            <input type="file" id="restoreInput" style="display:none" onchange="restoreData(this)">
        </div>
    </div>

    <label for="sessionDate">Session Date:</label>
    <input type="date" id="sessionDate">

    <div class="container-flex">
        
        <div class="col-master">
            <div class="group-container" style="background-color: #f9f9f9;">
                <div class="master-header">üìÇ Master Player Bank</div>
                <div class="help-text">Database of all regulars.<br>Format: <strong>Name, Rating, M/W</strong> (One per line)</div>
                <textarea id="masterList" rows="30" oninput="updateDBStatus()" placeholder="Alex, 4, M&#10;Ben, 3, M&#10;...">Alex, 4, M
Ben, 3, M
Chloe, 5, W
David, 2, M
Emily, 3, W
Finn, 4, M
Grace, 2, W
Hugo, 5, M
Isaac, 3, M
Jane, 4, W
Karl, 2, M
Leah, 3, W
Mark, 5, M
Nina, 4, W
Owen, 2, M
Pam, 3, W
Quinn, 4, M
Rob, 3, M
Steve, 4, M
Tim, 2, M
Ursula, 3, W
Victor, 5, M
Will, 4, M
Xena, 3, W</textarea>
                <div id="dbStatus"></div>
            </div>
        </div>

        <div class="col-weekly">
            <div style="text-align: right; margin-bottom: 10px;">
                <button id="btnClear" onclick="clearWeeklyInputs()" style="padding: 5px 15px; font-size: 14px;">üóëÔ∏è Clear Groups</button>
            </div>

            <div id="resolverContainer" class="resolver-box">
                <div class="resolver-title">‚ö†Ô∏è Unknown Players Detected</div>
                <p>The following names are not in your Master Bank. Please fix typos or add them as new players.</p>
                <div id="resolverList"></div>
            </div>

            <div class="group-container">
                <div class="group-header">Group 1: Early (4:30 - 6:30)</div>
                <label>Players Playing This Week:</label>
                <div class="help-text">Paste names only (e.g., "Alex") OR full details.</div>
                <textarea id="playersG1" rows="6"></textarea>
                <label>Courts:</label>
                <textarea id="courtsG1" rows="1">1, 2</textarea>
            </div>

            <div class="group-container">
                <div class="group-header">Group 2: Late (5:30 - 7:30)</div>
                <label>Players Playing This Week:</label>
                <div class="help-text">Paste names only (e.g., "Isaac") OR full details.</div>
                <textarea id="playersG2" rows="10"></textarea>
                <label>Courts:</label>
                <textarea id="courtsG2" rows="1">3, 4, 5, 6</textarea>
            </div>
        </div>
    </div>

    <div class="button-row">
        <button id="btnGenerate" onclick="startGenerationProcess()">1. Generate Schedule</button>
        <button id="btnShare" onclick="openShareView()">2. View / Print PDF</button>
        <button id="btnWord" onclick="downloadWordDoc()">3. Download Word Doc</button>
    </div>

    <div id="errorContainer" class="error-box"></div>
    
    <div id="output" class="schedule-output"></div>

    <script>
        const STORAGE_KEY = 'tennis_staggered_v11_backup';

        // --- INITIALIZATION ---
        window.onload = function() {
            try {
                const dateInput = document.getElementById('sessionDate');
                const today = new Date();
                const dayOfWeek = 3; 
                let diff = (dayOfWeek + 7 - today.getDay()) % 7;
                if (diff === 0) diff = 7; 
                const nextWed = new Date(today);
                nextWed.setDate(today.getDate() + diff);
                dateInput.value = nextWed.toISOString().split('T')[0];
            } catch(e) {}

            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if(data.master) document.getElementById('masterList').value = data.master;
                    document.getElementById('playersG1').value = data.p1 || "";
                    document.getElementById('courtsG1').value = data.c1 || "";
                    document.getElementById('playersG2').value = data.p2 || "";
                    document.getElementById('courtsG2').value = data.c2 || "";
                }
            } catch(e) {}
            
            updateDBStatus();
        };

        // --- BACKUP & RESTORE FUNCTIONS ---
        function backupData() {
            const data = {
                master: document.getElementById('masterList').value,
                p1: document.getElementById('playersG1').value,
                c1: document.getElementById('courtsG1').value,
                p2: document.getElementById('playersG2').value,
                c2: document.getElementById('courtsG2').value,
                date: new Date().toISOString()
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = "tennis_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.master) document.getElementById('masterList').value = data.master;
                    if(data.p1) document.getElementById('playersG1').value = data.p1;
                    if(data.c1) document.getElementById('courtsG1').value = data.c1;
                    if(data.p2) document.getElementById('playersG2').value = data.p2;
                    if(data.c2) document.getElementById('courtsG2').value = data.c2;
                    
                    // Save to local storage immediately
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    updateDBStatus();
                    alert("Data restored successfully!");
                } catch(err) {
                    alert("Error reading file: " + err);
                }
            };
            reader.readAsText(file);
        }

        function clearWeeklyInputs() {
            if(confirm("Clear weekly inputs? Master Bank will be saved.")) {
                document.getElementById('playersG1').value = "";
                document.getElementById('playersG2').value = "";
                document.getElementById('resolverContainer').style.display = 'none';
            }
        }

        function getMasterDatabase() {
            const masterText = document.getElementById('masterList').value;
            const db = {};
            const lines = masterText.split(/\r?\n/);
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(',');
                if(parts.length >= 2) {
                    const name = parts[0].trim();
                    const ability = parseFloat(parts[1].trim());
                    let gender = 'U';
                    if(parts.length >= 3) gender = parts[2].trim().toUpperCase();
                    if(name && !isNaN(ability)) {
                        db[name.toLowerCase()] = { name: name, ability: ability, gender: gender };
                    }
                }
            });
            return db;
        }

        function updateDBStatus() {
            const db = getMasterDatabase();
            const count = Object.keys(db).length;
            document.getElementById('dbStatus').innerText = `‚úÖ Loaded ${count} players from Master Bank`;
        }

        // --- FUZZY MATCHING (Levenshtein Distance) ---
        function getSimilarity(s1, s2) {
            let longer = s1; let shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength == 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }
        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            let costs = new Array();
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }
        function findClosestMatch(name, dbKeys) {
            let bestMatch = null; let highestScore = 0;
            dbKeys.forEach(key => {
                const score = getSimilarity(name.toLowerCase(), key);
                if (score > highestScore) { highestScore = score; bestMatch = key; }
            });
            return highestScore > 0.6 ? bestMatch : null;
        }

        // --- PRE-GENERATION CHECK ---
        function startGenerationProcess() {
            document.getElementById('errorContainer').style.display = 'none';
            document.getElementById('output').style.display = 'none';
            document.getElementById('resolverContainer').style.display = 'none';

            const p1Text = document.getElementById('playersG1').value;
            const p2Text = document.getElementById('playersG2').value;
            const db = getMasterDatabase();
            const unknowns = [];

            const scanForUnknowns = (text, fieldId) => {
                const lines = text.split(/[\r\n,]+/);
                lines.forEach(line => {
                    let token = line.trim();
                    if(!token) return;
                    if (/\d/.test(token)) return; 
                    if (!db[token.toLowerCase()]) {
                        if(!unknowns.find(u => u.name === token)) {
                            unknowns.push({ name: token, fieldId: fieldId });
                        }
                    }
                });
            };

            scanForUnknowns(p1Text, 'playersG1');
            scanForUnknowns(p2Text, 'playersG2');

            if (unknowns.length > 0) { showResolver(unknowns, db); } 
            else { generateAllSchedules(); }
        }

        function showResolver(unknowns, db) {
            const container = document.getElementById('resolverList');
            container.innerHTML = "";
            const dbKeys = Object.keys(db);

            unknowns.forEach(u => {
                const closest = findClosestMatch(u.name, dbKeys);
                let suggestionHtml = "";
                if (closest) {
                    const properName = db[closest].name;
                    suggestionHtml = `<span>Did you mean: </span><button class="suggestion-btn" onclick="resolveTypo('${u.name}', '${properName}', '${u.fieldId}')">${properName}</button><span> OR </span>`;
                }

                const div = document.createElement('div');
                div.className = 'unknown-item';
                div.innerHTML = `<div class="unknown-name">"${u.name}"</div>${suggestionHtml}<div style="flex:1; display:flex; gap:5px; align-items:center;"><span>New:</span><input type="number" id="rating_${u.name}" placeholder="Rating" step="0.5" style="width:70px;"><select id="gender_${u.name}" style="width:60px;"><option value="M">M</option><option value="W">W</option></select><button class="add-btn" onclick="resolveNew('${u.name}')">Add to Bank</button></div>`;
                container.appendChild(div);
            });
            document.getElementById('resolverContainer').style.display = 'block';
        }

        function resolveTypo(wrongName, rightName, fieldId) {
            const field = document.getElementById(fieldId);
            const regex = new RegExp(`\\b${wrongName}\\b`, 'g');
            field.value = field.value.replace(regex, rightName);
            startGenerationProcess();
        }

        function resolveNew(name) {
            const rating = document.getElementById(`rating_${name}`).value;
            const gender = document.getElementById(`gender_${name}`).value;
            if(!rating) { alert("Please enter a rating."); return; }
            const masterBox = document.getElementById('masterList');
            const newLine = `\n${name}, ${rating}, ${gender}`;
            masterBox.value += newLine;
            updateDBStatus();
            startGenerationProcess();
        }

        // --- SCHEDULING ---
        function parsePlayers(text, db) {
            const rawLines = text.split(/[\r\n,]+/);
            const players = [];
            for (let i = 0; i < rawLines.length; i++) {
                let token = rawLines[i].trim();
                if(token.length === 0) continue;
                if (db[token.toLowerCase()]) { players.push(db[token.toLowerCase()]); } 
                else if (i + 1 < rawLines.length && !isNaN(parseFloat(rawLines[i+1]))) {
                    const name = token;
                    const ability = parseFloat(rawLines[i+1]);
                    let gender = 'U';
                    if(i + 2 < rawLines.length) {
                        const potentialGender = rawLines[i+2].trim().toUpperCase();
                        if(potentialGender === 'M' || potentialGender === 'W') { gender = potentialGender; i += 2; } else { i += 1; }
                    } else { i += 1; }
                    players.push({ name, ability, gender });
                }
                else { players.push({ name: token + " (?)", ability: 3, gender: 'U' }); }
            }
            return players;
        }

        function parseCourts(text) {
            return text.replace(/[\r\n]+/g, ',').split(',').map(c => c.trim()).filter(c => c.length > 0);
        }

        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        function determinePlayPool(allPlayers, capacity) {
            if (allPlayers.length <= capacity) return { playing: allPlayers, sitting: [] };
            const neededToSit = allPlayers.length - capacity;
            const ratedFive = shuffle(allPlayers.filter(p => p.ability >= 5));
            const others = shuffle(allPlayers.filter(p => p.ability < 5));
            others.sort((a,b) => b.ability - a.ability);

            const sitOuts = [];
            const playing = [];

            while (sitOuts.length < neededToSit && ratedFive.length > 0) sitOuts.push(ratedFive.pop());
            while (sitOuts.length < neededToSit && others.length > 0) sitOuts.push(others.shift());

            playing.push(...ratedFive);
            playing.push(...others);
            return { playing: playing, sitting: sitOuts };
        }

        function getPairKey(p1, p2) { return [p1.name, p2.name].sort().join('|'); }

        function scheduleGroup(players, courts, timeSlots) {
            if (players.length === 0) return null;
            if (courts.length === 0) throw "No courts defined for a group with players.";

            const capacity = courts.length * 4;

            // H1
            const selectionH1 = determinePlayPool([...players], capacity);
            selectionH1.playing.sort((a,b) => b.ability - a.ability);
            
            const res1 = createMatches(selectionH1.playing, courts, new Set());
            res1.sitOut = selectionH1.sitting;
            
            const history = new Set();
            res1.matches.forEach(m => {
                history.add(getPairKey(m[0], m[1]));
                history.add(getPairKey(m[2], m[3]));
            });

            // H2
            const mustPlay = [...res1.sitOut];
            const playedNamesH1 = res1.matches.flat().map(p => p.name);
            const candidates = players.filter(p => playedNamesH1.includes(p.name));
            
            const selectionH2 = { playing: [...mustPlay], sitting: [] };
            const shuffledCandidates = shuffle(candidates);
            
            while(selectionH2.playing.length < capacity && shuffledCandidates.length > 0) {
                selectionH2.playing.push(shuffledCandidates.pop());
            }
            selectionH2.sitting = shuffledCandidates;
            selectionH2.playing.sort((a,b) => b.ability - a.ability);

            const res2 = createMatches(selectionH2.playing, courts, history);
            res2.sitOut = selectionH2.sitting;

            return { time1: timeSlots[0], round1: res1, time2: timeSlots[1], round2: res2 };
        }

        function createMatches(pool, courts, partnerHistory) {
            const matches = [];
            let tempPool = [...pool];
            for(let i=0; i<courts.length; i++) {
                if(tempPool.length < 4) break;
                let p1 = tempPool.shift();
                let p2 = tempPool.shift();
                let p3 = tempPool.shift(); 
                let p4 = tempPool.shift();
                
                const courtPlayers = [p1, p2, p3, p4];
                const combos = [[[0,1], [2,3]], [[0,2], [1,3]], [[0,3], [1,2]]];
                let bestScore = -99999;
                let bestCombo = null;

                combos.forEach(combo => {
                    const t1a = courtPlayers[combo[0][0]]; const t1b = courtPlayers[combo[0][1]];
                    const t2a = courtPlayers[combo[1][0]]; const t2b = courtPlayers[combo[1][1]];
                    let score = 0;
                    if (partnerHistory.has(getPairKey(t1a, t1b))) score -= 10000;
                    if (partnerHistory.has(getPairKey(t2a, t2b))) score -= 10000;
                    const t1Mixed = (t1a.gender !== t1b.gender && t1a.gender !== 'U' && t1b.gender !== 'U');
                    const t2Mixed = (t2a.gender !== t2b.gender && t2a.gender !== 'U' && t2b.gender !== 'U');
                    if (t1Mixed && t2Mixed) score += 500; 
                    else if (t1Mixed || t2Mixed) score += 50;
                    const t1Sum = t1a.ability + t1b.ability;
                    const t2Sum = t2a.ability + t2b.ability;
                    score -= (Math.abs(t1Sum - t2Sum) * 20); 
                    if (score > bestScore) { bestScore = score; bestCombo = [t1a, t1b, t2a, t2b]; }
                });
                matches.push(bestCombo);
            }
            return { matches: matches, sitOut: [] };
        }

        // --- RENDER & DISPLAY ---
        function generateAllSchedules() {
            const errBox = document.getElementById('errorContainer');
            const outBox = document.getElementById('output');
            errBox.style.display = 'none';
            outBox.style.display = 'none';
            
            try {
                const master = document.getElementById('masterList').value;
                const p1Text = document.getElementById('playersG1').value;
                const c1Text = document.getElementById('courtsG1').value;
                const p2Text = document.getElementById('playersG2').value;
                const c2Text = document.getElementById('courtsG2').value;

                const saveData = { master: master, p1: p1Text, c1: c1Text, p2: p2Text, c2: c2Text };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));

                const db = getMasterDatabase();
                const players1 = parsePlayers(p1Text, db);
                const courts1 = parseCourts(c1Text);
                const result1 = scheduleGroup(players1, courts1, ["4:30 PM - 5:30 PM", "5:30 PM - 6:30 PM"]);
                const players2 = parsePlayers(p2Text, db);
                const courts2 = parseCourts(c2Text);
                const result2 = scheduleGroup(players2, courts2, ["5:30 PM - 6:30 PM", "6:30 PM - 7:30 PM"]);

                let html = "<div class='drag-hint'>üí° <strong>Tip:</strong> Drag individual player chips to swap them manually.</div>";
                if (result1) html += renderGroupHTML("Group 1 (Early Starters)", result1, courts1);
                if (result1 && result2) html += "<br><hr style='border-top: 3px double #003366;'><br>";
                if (result2) html += renderGroupHTML("Group 2 (Late Starters)", result2, courts2);

                if (html === "") throw "Please copy players into Group 1 or Group 2.";
                outBox.innerHTML = html;
                outBox.style.display = 'block';
                addDragAndDropListeners();
            } catch(err) {
                errBox.innerText = err;
                errBox.style.display = 'block';
            }
        }

        function renderGroupHTML(groupTitle, data, courtNames) {
            let html = `<h2>${groupTitle}</h2>`;
            const buildTable = (time, roundData) => {
                let t = `<h3>${time}</h3>`;
                t += `<table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
                roundData.matches.forEach((m, idx) => {
                    let cName = courtNames[idx] || `C${idx+1}`;
                    t += `<tr>
                        <td style="font-weight:bold;">${cName}</td>
                        <td><span class="player-chip" draggable="true">${m[0].name}</span> & <span class="player-chip" draggable="true">${m[1].name}</span></td>
                        <td><span class="player-chip" draggable="true">${m[2].name}</span> & <span class="player-chip" draggable="true">${m[3].name}</span></td>
                    </tr>`;
                });
                if (roundData.sitOut.length > 0) {
                    t += `<tr><td class="sit-out" colspan="3">Sit Out: ${roundData.sitOut.map(p => `<span class="player-chip" draggable="true" style="background-color:white;">${p.name}</span>`).join(' ')}</td></tr>`;
                }
                t += `</table>`;
                return t;
            };
            html += buildTable(data.time1, data.round1);
            html += buildTable(data.time2, data.round2);
            return html;
        }

        // --- DRAG AND DROP ---
        function addDragAndDropListeners() {
            let dragSrcEl = null;
            function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.style.opacity = '0.4'; }
            function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; this.classList.add('over'); return false; }
            function handleDragLeave(e) { this.classList.remove('over'); }
            function handleDrop(e) { if (e.stopPropagation) e.stopPropagation(); if (dragSrcEl !== this) { const temp = this.innerHTML; this.innerHTML = dragSrcEl.innerHTML; dragSrcEl.innerHTML = temp; } return false; }
            function handleDragEnd(e) { this.style.opacity = '1'; document.querySelectorAll('.player-chip').forEach(item => item.classList.remove('over')); }
            document.querySelectorAll('.player-chip').forEach(item => { item.addEventListener('dragstart', handleDragStart, false); item.addEventListener('dragenter', handleDragOver, false); item.addEventListener('dragover', handleDragOver, false); item.addEventListener('dragleave', handleDragLeave, false); item.addEventListener('drop', handleDrop, false); item.addEventListener('dragend', handleDragEnd, false); });
        }

        // --- EXPORTS ---
        function openShareView() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            if (outBox.style.display === 'none') { alert("Generate schedule first."); return; }
            let cleanHTML = outBox.innerHTML.replace(/<span class="player-chip"[^>]*>/g, "").replace(/<\/span>/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");
            const win = window.open("", "_blank");
            win.document.write(`<html><head><title>Schedule ${dateStr}</title><style>body { font-family: Arial, sans-serif; padding: 20px; color: #333; text-align: center; } h1 { color: #003366; } h2 { background-color: #003366; color: white; padding: 5px; margin-top: 30px; border-radius: 4px; } h3 { color: #003366; margin-bottom: 5px; margin-top: 15px; } table { width: 100%; max-width: 800px; margin: 0 auto; border-collapse: collapse; border: 2px solid #003366; } th { background-color: #003366; color: white; padding: 8px; } td { border: 1px solid #ccc; padding: 8px; } .sit-out { background-color: #eef; font-weight: bold; } @media print { button { display: none; } }</style></head><body><h1>üéæ Schedule - ${dateStr}</h1>${cleanHTML}<br><button onclick="window.print()">Print / PDF</button></body></html>`);
            win.document.close();
        }

        function downloadWordDoc() {
            const outBox = document.getElementById('output');
            const dateStr = document.getElementById('sessionDate').value;
            if (outBox.style.display === 'none') { alert("Generate schedule first."); return; }
            let cleanHTML = outBox.innerHTML.replace(/<span class="player-chip"[^>]*>/g, "").replace(/<\/span>/g, "").replace(/<div class="drag-hint">.*?<\/div>/, "");
            var header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Tennis Schedule</title><style>body { font-family: Arial, sans-serif; } h1, h2, h3 { color: #003366; } h2 { background-color: #003366; color: white; padding: 5px; } table { border-collapse: collapse; width: 100%; margin-bottom: 20px; } td, th { border: 1px solid #003366; padding: 8px; text-align: center; } th { background-color: #003366; color: white; } .sit-out { background-color: #eef; font-weight: bold; }</style></head><body><h1>üéæ Wednesday Schedule - " + dateStr + "</h1>";
            var sourceHTML = header + cleanHTML + "</body></html>";
            var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            var fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'tennis_schedule_' + dateStr + '.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }
    </script>
</body>
</html>
